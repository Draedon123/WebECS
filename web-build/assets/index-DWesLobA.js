!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&n(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}function n(t){if(t.ep)return;t.ep=!0;const n=e(t);fetch(t.href,n)}}();class U{static instance=null;entityComponentMap;componentEntityMap;nextId;freeIds;constructor(){this.entityComponentMap=new Map,this.componentEntityMap=new Map,this.nextId=0,this.freeIds=[]}static getInstance(){return null===U.instance&&(U.instance=new U),U.instance}queryMultiple(t){const e=t.queries.map(this.querySingular.bind(this));switch(t.type){case"union":return et(e);case"intersection":return nt(e)}}querySingular(t){const e=("components"in t?t.components.map(t=>"string"==typeof t?t:t.tag):["string"==typeof t.component?t.component:t.component.tag]).map(t=>this.componentEntityMap.get(t)??[]);switch(t.type){case"union":return et(e);case"intersection":return nt(e);case"singleMatch":return e[0]}}createEntity(...t){const e=this.freeIds.length>0?this.freeIds.pop():this.nextId++;this.entityComponentMap.set(e,[]);for(const n of t)this.addComponent(e,n);return e}destroyEntity(t){const e=this.entityComponentMap.get(t);if(void 0!==e){this.entityComponentMap.delete(t);for(const n of e){const e=this.componentEntityMap.get(n.tag);e.splice(e.indexOf(t),1)}}else console.error(`Entity ${t} does not exist`)}addComponent(t,e){const n=this.entityComponentMap.get(t);if(void 0===n)return void console.error(`Entity ${t} does not exist`);n.push(e);const s=this.componentEntityMap.get(e.tag)??[];s.push(t),this.componentEntityMap.set(e.tag,s)}getComponent(t,e){const n=this.entityComponentMap.get(t);return void 0===n?(console.error(`Entity ${t} does not exist`),null):n.find(t=>t.tag===e)??null}}function et(t){return ot(t.flat())}function nt(t){const e=t.flat(),n=new Map;for(const t of e)n.has(t)?n.set(t,n.get(t)+1):n.set(t,1);return ot(e.filter(e=>n.get(e)===t.length))}function ot(t){const e=new Map;return t.filter(t=>!e.has(t)&&(e.set(t,!0),!0))}class F{tag;constructor(t){this.tag=t}}class I{shader;code;label;constructor(t,e){this.code=t,this.label=e}get initialised(){return void 0!==this.shader}initialise(t){this.initialised||(this.shader=t.createShaderModule({label:this.label,code:this.code}))}static async fetch(t,e,n=t=>t){const s=await(await fetch(t)).text(),o=await I.preprocess(t,s);return new I(n(o),e)}static async preprocess(t,e){return I.resolveImports(t,e)}static async resolveImports(t,e,n=[]){const s=/#!import.*\s/g,o=t.split("/"),i=o.slice(0,o.length-1).join("/")+"/",r=e.match(s)?.map(t=>t.replaceAll(/(#!import)|\s/g,"")).filter(t=>!n.includes(t)).map(t=>i+t+".wgsl")??[];return((await Promise.all(r.map(async t=>{const e=await fetch(t);if(!e.ok)return"";const s=await e.text();return I.resolveImports(t,s,n)}))).join("")+e).replaceAll(s,"")}}class ${components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(t){const e=new $;return e.components[0]=t.components[0],e.components[1]=t.components[1],e.components[2]=t.components[2],e.components[3]=t.components[4],e.components[4]=t.components[5],e.components[5]=t.components[6],e.components[6]=t.components[8],e.components[7]=t.components[9],e.components[8]=t.components[10],e}transpose(){const t=this.components[1],e=this.components[2],n=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=t,this.components[5]=this.components[7],this.components[6]=e,this.components[7]=n,this}}class B{components;constructor(){this.components=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static multiplyMatrices(t,e,n=new B){const s=t.components[0],o=t.components[1],i=t.components[2],r=t.components[3],a=t.components[4],c=t.components[5],h=t.components[6],p=t.components[7],u=t.components[8],l=t.components[9],m=t.components[10],d=t.components[11],f=t.components[12],g=t.components[13],w=t.components[14],y=t.components[15];let x=e.components[0],v=e.components[1],b=e.components[2],M=e.components[3];return n.components[0]=x*s+v*a+b*u+M*f,n.components[1]=x*o+v*c+b*l+M*g,n.components[2]=x*i+v*h+b*m+M*w,n.components[3]=x*r+v*p+b*d+M*y,x=e.components[4],v=e.components[5],b=e.components[6],M=e.components[7],n.components[4]=x*s+v*a+b*u+M*f,n.components[5]=x*o+v*c+b*l+M*g,n.components[6]=x*i+v*h+b*m+M*w,n.components[7]=x*r+v*p+b*d+M*y,x=e.components[8],v=e.components[9],b=e.components[10],M=e.components[11],n.components[8]=x*s+v*a+b*u+M*f,n.components[9]=x*o+v*c+b*l+M*g,n.components[10]=x*i+v*h+b*m+M*w,n.components[11]=x*r+v*p+b*d+M*y,x=e.components[12],v=e.components[13],b=e.components[14],M=e.components[15],n.components[12]=x*s+v*a+b*u+M*f,n.components[13]=x*o+v*c+b*l+M*g,n.components[14]=x*i+v*h+b*m+M*w,n.components[15]=x*r+v*p+b*d+M*y,n}static perspective(t,e,n,s){const o=new B,i=1/Math.tan(t/2);if(o.components[0]=i/e,o.components[5]=i,o.components[11]=-1,o.components[15]=0,s!==1/0){const t=1/(n-s);o.components[10]=s*t,o.components[14]=s*n*t}else o.components[10]=-1,o.components[14]=-n;return o}static lookAt(t,e,n){const s=new B,o=1e-6;let i,r,a,c,h,p,u,l,m,d;const f=t.x,g=t.y,w=t.z,y=n.x,x=n.y,v=n.z,b=e.x,M=e.y,E=e.z;return Math.abs(f-b)<o&&Math.abs(g-M)<o&&Math.abs(w-E)<o?(console.warn("Look At too close to Position"),new B):(u=f-b,l=g-M,m=w-E,d=1/Math.sqrt(u*u+l*l+m*m),u*=d,l*=d,m*=d,i=x*m-v*l,r=v*u-y*m,a=y*l-x*u,d=Math.sqrt(i*i+r*r+a*a),d?(d=1/d,i*=d,r*=d,a*=d):(i=0,r=0,a=0),c=l*a-m*r,h=m*i-u*a,p=u*r-l*i,d=Math.sqrt(c*c+h*h+p*p),d?(d=1/d,c*=d,h*=d,p*=d):(c=0,h=0,p=0),s.components[0]=i,s.components[1]=c,s.components[2]=u,s.components[3]=0,s.components[4]=r,s.components[5]=h,s.components[6]=l,s.components[7]=0,s.components[8]=a,s.components[9]=p,s.components[10]=m,s.components[11]=0,s.components[12]=-(i*f+r*g+a*w),s.components[13]=-(c*f+h*g+p*w),s.components[14]=-(u*f+l*g+m*w),s.components[15]=1,s)}copyFrom(t){return this.components.set(t.components),this}invert(){const t=this.components[0],e=this.components[1],n=this.components[2],s=this.components[3],o=this.components[4],i=this.components[5],r=this.components[6],a=this.components[7],c=this.components[8],h=this.components[9],p=this.components[10],u=this.components[11],l=this.components[12],m=this.components[13],d=this.components[14],f=this.components[15],g=t*i-e*o,w=t*r-n*o,y=t*a-s*o,x=e*r-n*i,v=e*a-s*i,b=n*a-s*r,M=c*m-h*l,B=c*d-p*l,E=c*f-u*l,F=h*d-p*m,P=h*f-u*m,T=p*f-u*d,U=g*T-w*P+y*F+x*E-v*B+b*M;if(Math.abs(U)<1e-6)return console.warn("Determinant too close to 0. Matrix not inverted"),this;const C=1/U;return this.components[0]=(i*T-r*P+a*F)*C,this.components[1]=(n*P-e*T-s*F)*C,this.components[2]=(m*b-d*v+f*x)*C,this.components[3]=(p*v-h*b-u*x)*C,this.components[4]=(r*E-o*T-a*B)*C,this.components[5]=(t*T-n*E+s*B)*C,this.components[6]=(d*y-l*b-f*w)*C,this.components[7]=(c*b-p*y+u*w)*C,this.components[8]=(o*P-i*E+a*M)*C,this.components[9]=(e*E-t*P-s*M)*C,this.components[10]=(l*v-m*y+f*g)*C,this.components[11]=(h*y-c*v-u*g)*C,this.components[12]=(i*B-o*F-r*M)*C,this.components[13]=(t*F-e*B+n*M)*C,this.components[14]=(m*w-l*x-d*g)*C,this.components[15]=(c*x-h*w+p*g)*C,this}static fromTranslation(t){const e=new B;return e.components[12]=t.x,e.components[13]=t.y,e.components[14]=t.z,e}static fromScale(t){const e=new B;return e.components[0]=t.x,e.components[5]=t.y,e.components[10]=t.z,e}}class st{components;constructor(t=0,e=0){this.components=new Float32Array([t,e])}*[Symbol.iterator](){yield this.x,yield this.y}get x(){return this.components[0]}get y(){return this.components[1]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}}class T{components;constructor(t=0,e=0,n=0){this.components=new Float32Array([t,e,n])}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}static add(t,e){return new T(t.x+e.x,t.y+e.y,t.z+e.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}static subtract(t,e){return new T(t.x-e.x,t.y-e.y,t.z-e.z)}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}normalise(){const t=this.magnitude;return t<1e-6?(console.warn("Vector magnitude too close to 0 to be normalised"),this):(this.scale(1/t),this)}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class V{components;constructor(t=0,e=0,n=0,s=1){this.components=new Float32Array([t,e,n,s])}multiply(t){const e=this.x,n=this.y,s=this.z,o=this.w,i=t.x,r=t.y,a=t.z,c=t.w;return this.x=o*i+e*c+n*a-s*r,this.y=o*r-e*a+n*c+s*i,this.z=o*a+e*r-n*i+s*c,this.w=o*c-e*i-n*r-s*a,this}static clone(t){return new V(t.x,t.y,t.z,t.w)}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this}static invert(t){return V.clone(t).invert()}invert(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to invert"),this;const e=1/(t*t);return this.x*=-e,this.y*=-e,this.z*=-e,this.w*=e,this}normalise(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}set w(t){this.components[3]=t}}const it=180/Math.PI;function O(t){return t*it}const rt=Math.PI/180;function q(t){return t*rt}function ct(t,e,n){return Math.max(Math.min(t,n),e)}function W(t,e){return t+e-t%e}function N(t){const e=new B;if(void 0!==t.position){const n=B.fromTranslation(t.position);B.multiplyMatrices(e,n,e)}if(void 0!==t.rotation){const n=t.rotation.calculateRotationMatrix();B.multiplyMatrices(e,n,e)}if(void 0!==t.scale){const n=B.fromScale(t.scale);B.multiplyMatrices(e,n,e)}return e}function at(t){const e=t instanceof B?t:N(t);return $.fromMatrix4(e.invert()).transpose()}class Y extends F{static tag="Position";position;constructor(t=0,e=0,n=0){super(Y.tag),this.position=new T(t,e,n)}translate(t,e,n){"number"==typeof t&&(t=new T(t,e,n)),this.position.add(t)}get x(){return this.position.x}get y(){return this.position.y}get z(){return this.position.z}set x(t){this.position.x=t}set y(t){this.position.y=t}set z(t){this.position.z=t}}class E extends F{static tag="Rotation";quaternion;constructor(t=0,e=0,n=0){super(E.tag),t=q(t),e=q(e),n=q(n);const s=Math.sin(t/2),o=Math.cos(t/2),i=Math.sin(e/2),r=Math.cos(e/2),a=Math.sin(n/2),c=Math.cos(n/2);this.quaternion=new V(s*r*c-o*i*a,o*i*c+s*r*a,o*r*a-s*i*c,o*r*c+s*i*a)}getEulerAngles(){this.quaternion.normalise();const t=this.calculateRotationMatrix();let e,n;const s=Math.asin(-ct(t.components[2],-1,1));return Math.abs(t.components[2])<.9999999?(e=Math.atan2(t.components[6],t.components[10]),n=Math.atan2(t.components[1],t.components[0])):(e=0,n=Math.atan2(-t.components[4],t.components[5])),[O(e),O(s),O(n)]}setEulerAngles(t,e,n){return this.quaternion.copyFrom(new E(t,e,n).quaternion),this}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new E(t,e[1],e[2]).quaternion)}set eulerY(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new E(e[0],t,e[2]).quaternion)}set eulerZ(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new E(e[0],e[1],t).quaternion)}rotateX(t){this.quaternion.multiply(new E(t,0,0).quaternion)}rotateY(t){this.quaternion.multiply(new E(0,t,0).quaternion)}rotateZ(t){this.quaternion.multiply(new E(0,0,t).quaternion)}calculateRotationMatrix(){const t=this.quaternion.x,e=this.quaternion.y,n=this.quaternion.z,s=this.quaternion.w,o=new B;return o.components[0]=1-2*(e*e+n*n),o.components[1]=2*(t*e+n*s),o.components[2]=2*(t*n-e*s),o.components[4]=2*(t*e-n*s),o.components[5]=1-2*(t*t+n*n),o.components[6]=2*(s*t+e*n),o.components[8]=2*(e*s+t*n),o.components[9]=2*(e*n-t*s),o.components[10]=1-2*(t*t+e*e),o}}class Z extends F{static tag="Scale";scale;constructor(t=1,e,n){super(Z.tag),"number"==typeof t&&(t=void 0!==e?new T(t,e,n):new T(t,t,t)),this.scale=t}get x(){return this.scale.x}get y(){return this.scale.y}get z(){return this.scale.z}set x(t){this.scale.x=t}set y(t){this.scale.y=t}set z(t){this.scale.z=t}scaleBy(t){this.scale.scale(t)}setScale(t){this.scale.x=t,this.scale.y=t,this.scale.z=t}}class H extends F{static tag="PerspectiveCamera";fovDegrees;near;far;aspectRatio;constructor(t={}){super(H.tag),this.fovDegrees=t.fov??60,this.near=t.near??.001,this.far=t.far??1e3,this.aspectRatio=t.aspectRatio??16/9}get fovRadians(){return q(this.fovDegrees)}set fovRadians(t){this.fovDegrees=O(t)}calculatePerspectiveViewMatrix(t,e){const n=this.calculatePerspectiveMatrix(),s=this.calculateViewMatrix(t,e);return B.multiplyMatrices(n,s,s),s}calculateViewMatrix(t,e){return N({position:t,rotation:e}).invert()}calculatePerspectiveMatrix(){return B.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}}class ht{buffer;dataview;littleEndian;offset;constructor(t,e=!0,n=0){this.buffer=new ArrayBuffer(t),this.dataview=new DataView(this.buffer),this.littleEndian=e,this.offset=n}writeUint8(t){this.dataview.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeVec3f(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeMat3x3f(t){this.writeFloat32(t.components[0]),this.writeFloat32(t.components[1]),this.writeFloat32(t.components[2]),this.pad(4),this.writeFloat32(t.components[3]),this.writeFloat32(t.components[4]),this.writeFloat32(t.components[5]),this.pad(4),this.writeFloat32(t.components[6]),this.writeFloat32(t.components[7]),this.writeFloat32(t.components[8])}writeMat4x4f(t){new Float32Array(this.buffer,this.offset,16).set(t.components),this.offset+=64}pad(t){this.offset+=t}}class X extends F{static tag="VertexArray";label;vertexBuffer;rawVertices;constructor(t,e=""){super(X.tag),this.rawVertices=t,this.label=e}get initialised(){return void 0!==this.vertexBuffer}initialise(t){if(this.initialised)return;const e=new Float32Array(this.rawVertices.map(({position:t,uv:e,normal:n})=>[...t,...e,...n]).flat());this.vertexBuffer=t.createBuffer({label:`${this.label} Vertex Buffer`,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.vertexBuffer,0,e)}get vertexCount(){return this.rawVertices.length}}class D extends F{static tag="IndexArray";label;indexBuffer;rawIndices;constructor(t,e=""){super(D.tag),this.rawIndices=t,this.label=e}get initialised(){return void 0!==this.indexBuffer}initialise(t){if(this.initialised)return;const e=void 0,n=new("uint32"===this.indexFormat?Uint32Array:Uint16Array)("uint16"===this.indexFormat?W(this.rawIndices.length,2):this.rawIndices.length);n.set(this.rawIndices),this.indexBuffer=t.createBuffer({label:`${this.label} Index Buffer`,size:W(n.byteLength,4),usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.indexBuffer,0,n)}get indexFormat(){return Math.max(...this.rawIndices)>65535?"uint32":"uint16"}get indexCount(){return this.rawIndices.length}}async function lt(t){const e=(await(await fetch(t)).text()).split(/[\r\n]+/),n=[],s=[],o=[],i=[],r=[],a={},c=[];for(const h of e){if("#"===h[0])continue;const e=h.split(" ");switch(e[0]){case"mtllib":{const n=t.split("/").slice(0,-1).join("/")+"/"+e.slice(1).join(" "),s=await pt(n);for(const t of s)a[t.name]=t;break}case"usemtl":""===c[c.length-1].materialName?c[c.length-1].materialName=e[1]:(c[c.length-1].indices=new D(s.splice(0,s.length)),c.push({name:"_"+c[c.length-1].name,materialName:e[1],vertices:new X(n)}));break;case"o":{const t=e[1];c.length>0&&(c[c.length-1].indices=new D(s.splice(0,s.length))),c.push({name:t,materialName:"",vertices:new X(n)});break}case"v":{const t=e[4]?parseFloat(e[4]):1,n=parseFloat(e[1])/t,s=parseFloat(e[2])/t,i=parseFloat(e[3])/t;o.push(new T(n,s,i));break}case"vt":{const t=parseFloat(e[1]),n=e[2]?parseFloat(e[2]):0;i.push(new st(t,n));break}case"vn":{const t=parseFloat(e[1]),n=parseFloat(e[2]),s=parseFloat(e[3]);r.push(new T(t,n,s).normalise());break}case"f":{for(let t=1;t<e.length;t++){const s=e[t].split("/"),a=parseInt(s[0])-1,c=parseInt(s[1])-1,h=parseInt(s[2])-1,p=o.at(a),u=i.at(c)??new st(0,0),l=r.at(h)??new T(0,0,1);n.push({position:p,uv:u,normal:l})}const t=e.length-1,a=n.length-t;for(let e=1;e<t-1;e++)s.push(a,a+e,a+e+1);break}}}return c[c.length-1].indices=new D(s),{meshes:c,materials:a}}async function pt(t){const e=(await(await fetch(t)).text()).split(/(newmtl)/),n=[];for(let s=0;s<e.length;s++){if(!e[s-1]?.startsWith("newmtl"))continue;const o=("newmtl"+e[s]).split(/[\r\n]+/),i={};for(const e of o){const n=e.split(" ");switch(n[0]){case"newmtl":i.name=n[1];break;case"Kd":{const t=255*parseFloat(n[1]),e=255*parseFloat(n[2]),s=255*parseFloat(n[3]);i.texture=z.colour(t,e,s);break}case"map_Kd":{const e=t.split("/").slice(0,-1).join("/")+"/"+n.slice(1).join(" "),s=await z.fetch(e);i.texture=s;break}}}i.texture||(i.texture=z.colour(255,255,255)),n.push(i)}return n}class J extends F{static tag="MeshReference";meshKey;constructor(t){super(J.tag),this.meshKey=t}}class Q extends F{static tag="Children";children;constructor(t=[]){super(Q.tag),this.children=t}}class k extends F{static tag="Parent";parent;constructor(t=null){super(k.tag),this.parent=t}}class j{static DEFAULT_TEXTURE_KEY="default";textures;meshes;models;renderer;device;transformsBuffer;transformByteLength;transformsPadding;constructor(t,e,n){this.textures={},this.meshes={},this.models={},this.renderer=t,this.device=e,this.transformByteLength=112;const s=W(this.transformByteLength,e.limits.minUniformBufferOffsetAlignment);this.transformsPadding=s-this.transformByteLength,this.transformsBuffer=e.createBuffer({label:"Transforms Buffer",size:s*n,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const o=z.colour(255,255,255);o.initialise(e),this.addTexture(j.DEFAULT_TEXTURE_KEY,o)}addTexture(t,e){t in this.textures&&this.textures[t].texture?.texture.destroy(),e.initialise(this.device),this.textures[t]={texture:e,bindGroup:this.device.createBindGroup({layout:this.renderer.perObjectBindGroupLayout,entries:[{binding:0,resource:{buffer:this.transformsBuffer,size:this.transformByteLength+this.transformsPadding}},{binding:1,resource:e.texture.createView()}]})}}getTexture(t){return this.textures[t]??null}addMesh(t,e){t in this.meshes&&(this.meshes[t].vertices.vertexBuffer?.destroy(),this.meshes[t]?.indices?.indexBuffer?.destroy()),e.vertices.initialise(this.device),e.indices?.initialise(this.device),this.meshes[t]=e}getMesh(t){return this.meshes[t]??null}async loadModel(t,e,n){switch(n){case"obj":{const n=await lt(t);for(const t of Object.values(n.materials))this.addTexture(t.name,t.texture);for(let t=0;t<n.meshes.length;t++){const e=n.meshes[t];this.addMesh(e.name,e)}this.models[e]=Object.values(n.meshes).map(t=>({meshReference:t.name,textureReference:t.materialName}));break}default:console.error(`Unsupported model type ${n}`)}}getModel(t){return this.models[t]??null}spawnModel(t){if(!(t in this.models))throw new Error(`Model with key ${t} not found`);const e=U.getInstance(),n=this.models[t],s=new Q,o=e.createEntity(s);for(const t of n){const n=new J(t.meshReference),i=new _(t.textureReference),r=new k(o),a=e.createEntity(n,i,r);s.children.push(a)}return o}}class _ extends F{static tag="TextureReference";textureKey;constructor(t){super(_.tag),this.textureKey=t}}function ut(t,e,n){const s=U.getInstance(),o=s.queryMultiple({type:"intersection",queries:[{type:"singleMatch",component:k}]});for(let i=0;i<o.length;i++){const r=o[i],a=s.getComponent(r,"MeshReference"),c=t.getMesh(a.meshKey);if(null===c){console.error(`No mesh found with key ${a.meshKey}`);continue}const h=s.getComponent(r,"TextureReference")?.textureKey??j.DEFAULT_TEXTURE_KEY,p=t.getTexture(h);if(null===p){console.error(`No texture found with key ${h}`);continue}const u=s.getComponent(r,"Parent")?.parent??null,l=s.getComponent(r,"Position")??void 0,m=s.getComponent(r,"Rotation")??void 0,d=s.getComponent(r,"Scale")??void 0,f=new ht(t.transformByteLength,void 0,0),g=N({position:l,rotation:m,scale:d});if(null!==u){const t=s.getComponent(u,"Position")??void 0,e=s.getComponent(u,"Rotation")??void 0,n=s.getComponent(u,"Scale")??void 0;B.multiplyMatrices(g,N({position:t,rotation:e,scale:n}),g)}const w=at(g);f.writeMat4x4f(g),f.writeMat3x3f(w);const y=i*(t.transformByteLength+t.transformsPadding);e.queue.writeBuffer(t.transformsBuffer,y,f.buffer),n.setVertexBuffer(0,c.vertices.vertexBuffer),n.setBindGroup(1,p.bindGroup,[i*(t.transformByteLength+t.transformsPadding)]),void 0!==c.indices?(c.indices.initialised||c.indices.initialise(e),n.setIndexBuffer(c.indices.indexBuffer,c.indices.indexFormat),n.drawIndexed(c.indices.indexCount,1)):n.draw(c.vertices.vertexCount,1)}}class K{canvas;settings;device;ctx;canvasFormat;bindGroup0;renderPipeline;depthTexture;resourceManager;perObjectBindGroupLayout;perspectiveViewMatrixBuffer;sampler;constructor(t,e,n={}){const s=t.getContext("webgpu");if(null===s)throw new Error("Could not create WebGPU Canvas Context");this.canvas=t,this.device=e,this.ctx=s,this.canvasFormat="rgba8unorm",this.settings={clearColour:n.clearColour??[0,0,0,1]},this.perspectiveViewMatrixBuffer=e.createBuffer({label:"Perspective View Matrix Buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.perObjectBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Per Object Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform",hasDynamicOffset:!0},visibility:GPUShaderStage.VERTEX},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT}]}),this.resourceManager=new j(this,e,128),this.depthTexture=this.createDepthTexture(),this.sampler=e.createSampler()}async initialise(){new ResizeObserver(t=>{const e=t[0],n=e.devicePixelContentBoxSize[0].inlineSize,s=e.devicePixelContentBoxSize[0].blockSize;this.canvas.width=n,this.canvas.height=s,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture()}).observe(this.canvas),await this.initialiseRendering()}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const t=await I.fetch("/WebECS/blinnPhong.wgsl");t.initialise(this.device);const e=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout 0",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT}]});this.bindGroup0=this.device.createBindGroup({label:"Renderer Bind Group 0",layout:e,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrixBuffer}},{binding:1,resource:this.sampler}]});const n=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[e,this.perObjectBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:n,vertex:{module:t.shader,entryPoint:"vertexMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12},{shaderLocation:2,format:"float32x3",offset:20}]}]},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{cullMode:"back"},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}})}render(t){const e=this.device.createCommandEncoder(),n=e.beginRenderPass({colorAttachments:[{loadOp:"clear",storeOp:"store",view:this.ctx.getCurrentTexture().createView(),clearValue:this.settings.clearColour}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}}),s=U.getInstance(),o=s.getComponent(t,"Position"),i=s.getComponent(t,"Rotation"),r=s.getComponent(t,"PerspectiveCamera");if(null===r)return void console.error("No camera found");if(null===o)return void console.error("Camera does not have position component");if(null===i)return void console.error("Camera does not have rotation component");const a=r.calculatePerspectiveViewMatrix(o,i);this.device.queue.writeBuffer(this.perspectiveViewMatrixBuffer,0,a.components.buffer),n.setPipeline(this.renderPipeline),n.setBindGroup(0,this.bindGroup0),ut(this.resourceManager,this.device,n),n.end(),this.device.queue.submit([e.finish(n)])}static async create(t,e={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(null===n)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const s=await n.requestDevice({requiredFeatures:K.requestFeatures(n,"timestamp-query")});if(null===s)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new K(t,s,e)}static requestFeatures(t,...e){return e.filter(e=>{const n=t.features.has(e);return n||console.warn(`GPU Feature ${e} not supported`),n})}}class z extends F{static tag="Texture";texture;source;width;height;label;constructor(t,e,n,s){super(z.tag),this.source=t,this.width=e,this.height=n,this.label=s}get initialised(){return void 0!==this.texture}initialise(t){this.texture=t.createTexture({label:this.label,size:[this.width,this.height],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),t.queue.copyExternalImageToTexture({source:this.source,flipY:!0},{texture:this.texture,origin:[0,0]},{width:this.width,height:this.height})}static async fetch(t,e){const n=await(await fetch(t)).blob(),s=await createImageBitmap(n);return new z(s,s.width,s.height,e)}static colour(t,e,n,s=255,o){const i=new ImageData(new Uint8ClampedArray([t,e,n,s]),1,1);return new z(i,1,1,o)}}async function mt(){const t=document.getElementById("main"),e=await K.create(t),n=U.getInstance();await e.initialise(),e.settings.clearColour=[.1,.1,.1,1];const s=new H({}),o=n.createEntity(s,new Y(0,10,10),new E(-45,0,0));await e.resourceManager.loadModel("/WebECS/web-assets/plane/plane.obj","Plane","obj");const i=e.resourceManager.spawnModel("Plane");function r(){s.aspectRatio=t.width/t.height,e.render(o),requestAnimationFrame(r)}console.log(e.resourceManager),n.addComponent(i,new Y(0,0,0)),n.addComponent(i,new Z(2)),n.addComponent(i,new E(0,180,0)),r()}mt();