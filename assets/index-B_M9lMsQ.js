!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&n(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}function n(t){if(t.ep)return;t.ep=!0;const n=e(t);fetch(t.href,n)}}();class F{static instance=null;entityComponentMap;componentEntityMap;nextId;freeIds;constructor(){this.entityComponentMap=new Map,this.componentEntityMap=new Map,this.nextId=0,this.freeIds=[]}static getInstance(){return null===F.instance&&(F.instance=new F),F.instance}queryMultiple(t){const e=t.queries.map(this.querySingular.bind(this));switch(t.type){case"union":return k(e);case"intersection":return J(e)}}querySingular(t){const e=("components"in t?t.components.map(t=>"string"==typeof t?t:t.tag):["string"==typeof t.component?t.component:t.component.tag]).map(t=>this.componentEntityMap.get(t)??[]);switch(t.type){case"union":return k(e);case"intersection":return J(e);case"singleMatch":return e[0]}}createEntity(){const t=this.freeIds.length>0?this.freeIds.pop():this.nextId++;return this.entityComponentMap.set(t,[]),t}destroyEntity(t){const e=this.entityComponentMap.get(t);if(void 0!==e){this.entityComponentMap.delete(t);for(const n of e){const e=this.componentEntityMap.get(n.tag);e.splice(e.indexOf(t),1)}}else console.error(`Entity ${t} does not exist`)}addComponent(t,e){const n=this.entityComponentMap.get(t);if(void 0===n)return void console.error(`Entity ${t} does not exist`);n.push(e);const o=this.componentEntityMap.get(e.tag)??[];o.push(t),this.componentEntityMap.set(e.tag,o)}getComponent(t,e){const n=this.entityComponentMap.get(t);return void 0===n?(console.error(`Entity ${t} does not exist`),null):n.find(t=>t.tag===e)??null}}function k(t){return Q(t.flat())}function J(t){const e=t.flat(),n=new Map;for(const t of e)n.has(t)?n.set(t,n.get(t)+1):n.set(t,1);return Q(e.filter(e=>n.get(e)===t.length))}function Q(t){const e=new Map;return t.filter(t=>!e.has(t)&&(e.set(t,!0),!0))}class O{tag;constructor(t){this.tag=t}}class L{shader;code;label;constructor(t,e){this.code=t,this.label=e}get initialised(){return void 0!==this.shader}initialise(t){this.initialised||(this.shader=t.createShaderModule({label:this.label,code:this.code}))}static async fetch(t,e,n=t=>t){const o=await(await fetch(t)).text(),s=await L.preprocess(t,o);return new L(n(s),e)}static async preprocess(t,e){return L.resolveImports(t,e)}static async resolveImports(t,e,n=[]){const o=/#!import.*\s/g,s=t.split("/"),i=s.slice(0,s.length-1).join("/")+"/",r=e.match(o)?.map(t=>t.replaceAll(/(#!import)|\s/g,"")).filter(t=>!n.includes(t)).map(t=>i+t+".wgsl")??[];return((await Promise.all(r.map(async t=>{const e=await fetch(t);if(!e.ok)return"";const o=await e.text();return L.resolveImports(t,o,n)}))).join("")+e).replaceAll(o,"")}}class K{components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(t){const e=new K;return e.components[0]=t.components[0],e.components[1]=t.components[1],e.components[2]=t.components[2],e.components[3]=t.components[4],e.components[4]=t.components[5],e.components[5]=t.components[6],e.components[6]=t.components[8],e.components[7]=t.components[9],e.components[8]=t.components[10],e}transpose(){const t=this.components[1],e=this.components[2],n=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=t,this.components[5]=this.components[7],this.components[6]=e,this.components[7]=n,this}}class N{components;constructor(){this.components=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}static multiplyMatrices(t,e,n=new N){const o=t.components[0],s=t.components[1],i=t.components[2],r=t.components[3],a=t.components[4],c=t.components[5],p=t.components[6],u=t.components[7],l=t.components[8],m=t.components[9],h=t.components[10],d=t.components[11],f=t.components[12],g=t.components[13],w=t.components[14],y=t.components[15];let v=e.components[0],P=e.components[1],x=e.components[2],M=e.components[3];return n.components[0]=v*o+P*a+x*l+M*f,n.components[1]=v*s+P*c+x*m+M*g,n.components[2]=v*i+P*p+x*h+M*w,n.components[3]=v*r+P*u+x*d+M*y,v=e.components[4],P=e.components[5],x=e.components[6],M=e.components[7],n.components[4]=v*o+P*a+x*l+M*f,n.components[5]=v*s+P*c+x*m+M*g,n.components[6]=v*i+P*p+x*h+M*w,n.components[7]=v*r+P*u+x*d+M*y,v=e.components[8],P=e.components[9],x=e.components[10],M=e.components[11],n.components[8]=v*o+P*a+x*l+M*f,n.components[9]=v*s+P*c+x*m+M*g,n.components[10]=v*i+P*p+x*h+M*w,n.components[11]=v*r+P*u+x*d+M*y,v=e.components[12],P=e.components[13],x=e.components[14],M=e.components[15],n.components[12]=v*o+P*a+x*l+M*f,n.components[13]=v*s+P*c+x*m+M*g,n.components[14]=v*i+P*p+x*h+M*w,n.components[15]=v*r+P*u+x*d+M*y,n}static perspective(t,e,n,o){const s=new N,i=1/Math.tan(t/2);if(s.components[0]=i/e,s.components[5]=i,s.components[11]=-1,s.components[15]=0,o!==1/0){const t=1/(n-o);s.components[10]=o*t,s.components[14]=o*n*t}else s.components[10]=-1,s.components[14]=-n;return s}static lookAt(t,e,n){const o=new N,s=1e-6;let i,r,a,c,p,u,l,m,h,d;const f=t.x,g=t.y,w=t.z,y=n.x,v=n.y,P=n.z,x=e.x,M=e.y,b=e.z;return Math.abs(f-x)<s&&Math.abs(g-M)<s&&Math.abs(w-b)<s?(console.warn("Look At too close to Position"),new N):(l=f-x,m=g-M,h=w-b,d=1/Math.sqrt(l*l+m*m+h*h),l*=d,m*=d,h*=d,i=v*h-P*m,r=P*l-y*h,a=y*m-v*l,d=Math.sqrt(i*i+r*r+a*a),d?(d=1/d,i*=d,r*=d,a*=d):(i=0,r=0,a=0),c=m*a-h*r,p=h*i-l*a,u=l*r-m*i,d=Math.sqrt(c*c+p*p+u*u),d?(d=1/d,c*=d,p*=d,u*=d):(c=0,p=0,u=0),o.components[0]=i,o.components[1]=c,o.components[2]=l,o.components[3]=0,o.components[4]=r,o.components[5]=p,o.components[6]=m,o.components[7]=0,o.components[8]=a,o.components[9]=u,o.components[10]=h,o.components[11]=0,o.components[12]=-(i*f+r*g+a*w),o.components[13]=-(c*f+p*g+u*w),o.components[14]=-(l*f+m*g+h*w),o.components[15]=1,o)}copyFrom(t){return this.components.set(t.components),this}invert(){const t=this.components[0],e=this.components[1],n=this.components[2],o=this.components[3],s=this.components[4],i=this.components[5],r=this.components[6],a=this.components[7],c=this.components[8],p=this.components[9],u=this.components[10],l=this.components[11],m=this.components[12],h=this.components[13],d=this.components[14],f=this.components[15],g=t*i-e*s,w=t*r-n*s,y=t*a-o*s,v=e*r-n*i,P=e*a-o*i,x=n*a-o*r,N=c*h-p*m,M=c*d-u*m,b=c*f-l*m,B=p*d-u*h,R=p*f-l*h,C=u*f-l*d,F=g*C-w*R+y*B+v*b-P*M+x*N;if(Math.abs(F)<1e-6)return console.warn("Determinant too close to 0. Matrix not inverted"),this;const L=1/F;return this.components[0]=(i*C-r*R+a*B)*L,this.components[1]=(n*R-e*C-o*B)*L,this.components[2]=(h*x-d*P+f*v)*L,this.components[3]=(u*P-p*x-l*v)*L,this.components[4]=(r*b-s*C-a*M)*L,this.components[5]=(t*C-n*b+o*M)*L,this.components[6]=(d*y-m*x-f*w)*L,this.components[7]=(c*x-u*y+l*w)*L,this.components[8]=(s*R-i*b+a*N)*L,this.components[9]=(e*b-t*R-o*N)*L,this.components[10]=(m*P-h*y+f*g)*L,this.components[11]=(p*y-c*P-l*g)*L,this.components[12]=(i*M-s*B-r*N)*L,this.components[13]=(t*B-e*M+n*N)*L,this.components[14]=(h*w-m*v-d*g)*L,this.components[15]=(c*v-p*w+u*g)*L,this}static fromTranslation(t){const e=new N;return e.components[12]=t.x,e.components[13]=t.y,e.components[14]=t.z,e}static fromScale(t){const e=new N;return e.components[0]=t.x,e.components[5]=t.y,e.components[10]=t.z,e}}class I{components;constructor(t=0,e=0){this.components=new Float32Array([t,e])}*[Symbol.iterator](){yield this.x,yield this.y}get x(){return this.components[0]}get y(){return this.components[1]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}}class P{components;constructor(t=0,e=0,n=0){this.components=new Float32Array([t,e,n])}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}static add(t,e){return new P(t.x+e.x,t.y+e.y,t.z+e.z)}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}scale(t){return this.x*=t,this.y*=t,this.z*=t,this}get magnitude(){return Math.hypot(this.x,this.y,this.z)}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class q{components;constructor(t=0,e=0,n=0,o=1){this.components=new Float32Array([t,e,n,o])}multiply(t){const e=this.x,n=this.y,o=this.z,s=this.w,i=t.x,r=t.y,a=t.z,c=t.w;return this.x=s*i+e*c+n*a-o*r,this.y=s*r-e*a+n*c+o*i,this.z=s*a+e*r-n*i+o*c,this.w=s*c-e*i-n*r-o*a,this}static clone(t){return new q(t.x,t.y,t.z,t.w)}copyFrom(t){return this.components[0]=t.components[0],this.components[1]=t.components[1],this.components[2]=t.components[2],this.components[3]=t.components[3],this}static invert(t){return q.clone(t).invert()}invert(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to invert"),this;const e=1/(t*t);return this.x*=-e,this.y*=-e,this.z*=-e,this.w*=e,this}normalise(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}set w(t){this.components[3]=t}}const _=180/Math.PI;function S(t){return t*_}const tt=Math.PI/180;function V(t){return t*tt}function et(t,e,n){return Math.max(Math.min(t,n),e)}function $(t){const e=new N;if(void 0!==t.position){const n=N.fromTranslation(t.position);N.multiplyMatrices(e,n,e)}if(void 0!==t.rotation){const n=t.rotation.calculateRotationMatrix();N.multiplyMatrices(e,n,e)}if(void 0!==t.scale){const n=N.fromScale(t.scale);N.multiplyMatrices(e,n,e)}return e}function nt(t){const e=$(t);return K.fromMatrix4(e.invert()).transpose()}class E extends O{static tag="Position";position;constructor(t=0,e=0,n=0){super(E.tag),this.position=new P(t,e,n)}translate(t,e,n){"number"==typeof t&&(t=new P(t,e,n)),this.position.add(t)}get x(){return this.position.x}get y(){return this.position.y}get z(){return this.position.z}set x(t){this.position.x=t}set y(t){this.position.y=t}set z(t){this.position.z=t}}class R extends O{static tag="Rotation";quaternion;constructor(t=0,e=0,n=0){super(R.tag),t=V(t),e=V(e),n=V(n);const o=Math.sin(t/2),s=Math.cos(t/2),i=Math.sin(e/2),r=Math.cos(e/2),a=Math.sin(n/2),c=Math.cos(n/2);this.quaternion=new q(o*r*c-s*i*a,s*i*c+o*r*a,s*r*a-o*i*c,s*r*c+o*i*a)}getEulerAngles(){this.quaternion.normalise();const t=this.calculateRotationMatrix();let e,n;const o=Math.asin(-et(t.components[2],-1,1));return Math.abs(t.components[2])<.9999999?(e=Math.atan2(t.components[6],t.components[10]),n=Math.atan2(t.components[1],t.components[0])):(e=0,n=Math.atan2(-t.components[4],t.components[5])),[S(e),S(o),S(n)]}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new R(t,e[1],e[2]).quaternion)}set eulerY(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new R(e[0],t,e[2]).quaternion)}set eulerZ(t){const e=this.getEulerAngles();this.quaternion.copyFrom(new R(e[0],e[1],t).quaternion)}rotateX(t){this.quaternion.multiply(new R(t,0,0).quaternion)}rotateY(t){this.quaternion.multiply(new R(0,t,0).quaternion)}rotateZ(t){this.quaternion.multiply(new R(0,0,t).quaternion)}calculateRotationMatrix(){const t=this.quaternion.x,e=this.quaternion.y,n=this.quaternion.z,o=this.quaternion.w,s=new N;return s.components[0]=1-2*(e*e+n*n),s.components[1]=2*(t*e+n*o),s.components[2]=2*(t*n-e*o),s.components[4]=2*(t*e-n*o),s.components[5]=1-2*(t*t+n*n),s.components[6]=2*(o*t+e*n),s.components[8]=2*(e*o+t*n),s.components[9]=2*(e*n-t*o),s.components[10]=1-2*(t*t+e*e),s}}class X extends O{static tag="Scale";scale;constructor(t=1,e,n){super(X.tag),"number"==typeof t&&(t=void 0!==e?new P(t,e,n):new P(t,t,t)),this.scale=t}get x(){return this.scale.x}get y(){return this.scale.y}get z(){return this.scale.z}set x(t){this.scale.x=t}set y(t){this.scale.y=t}set z(t){this.scale.z=t}scaleBy(t){this.scale.scale(t)}setScale(t){this.scale.x=t,this.scale.y=t,this.scale.z=t}}class W extends O{static tag="PerspectiveCamera";fovDegrees;near;far;aspectRatio;constructor(t={}){super(W.tag),this.fovDegrees=t.fov??60,this.near=t.near??.001,this.far=t.far??1e3,this.aspectRatio=t.aspectRatio??16/9}get fovRadians(){return V(this.fovDegrees)}set fovRadians(t){this.fovDegrees=S(t)}calculatePerspectiveViewMatrix(t,e){const n=this.calculatePerspectiveMatrix(),o=this.calculateViewMatrix(t,e);return N.multiplyMatrices(n,o,o),o}calculateViewMatrix(t,e){return $({position:t,rotation:e}).invert()}calculatePerspectiveMatrix(){return N.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}}class Y extends O{static tag="VertexArray";label;vertexBuffer;rawVertices;constructor(t,e=""){super(Y.tag),this.rawVertices=t,this.label=e}get initialised(){return void 0!==this.vertexBuffer}initialise(t){if(this.initialised)return;const e=new Float32Array(this.rawVertices.map(({position:t,uv:e,normal:n})=>[...t,...e,...n]).flat());this.vertexBuffer=t.createBuffer({label:`${this.label} Vertex Buffer`,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.vertexBuffer,0,e)}get vertexCount(){return this.rawVertices.length}}class Z extends O{static tag="BindGroup";bindGroup;descriptor;constructor(t){super(Z.tag),this.descriptor=t}get initialised(){return void 0!==this.bindGroup}initialise(t){this.initialised||(this.bindGroup=t.createBindGroup(this.descriptor))}}class H extends O{static tag="Buffer";buffer;label;size;usage;mappedAtCreation;constructor(t){super(H.tag),this.label=t.label,this.size=t.size,this.usage=t.usage,this.mappedAtCreation=t.mappedAtCreation??!1}get initialised(){return void 0!==this.buffer}initialise(t){this.initialised||(this.buffer=t.createBuffer({label:this.label,size:this.size,usage:this.usage,mappedAtCreation:this.mappedAtCreation}))}}class ot{buffer;dataview;littleEndian;offset;constructor(t,e=!0,n=0){this.buffer=new ArrayBuffer(t),this.dataview=new DataView(this.buffer),this.littleEndian=e,this.offset=n}writeUint8(t){this.dataview.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeVec3f(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeMat3x3f(t){this.writeFloat32(t.components[0]),this.writeFloat32(t.components[1]),this.writeFloat32(t.components[2]),this.pad(4),this.writeFloat32(t.components[3]),this.writeFloat32(t.components[4]),this.writeFloat32(t.components[5]),this.pad(4),this.writeFloat32(t.components[6]),this.writeFloat32(t.components[7]),this.writeFloat32(t.components[8])}writeMat4x4f(t){new Float32Array(this.buffer,this.offset,16).set(t.components),this.offset+=64}pad(t){this.offset+=t}}function st(t,e){const n=F.getInstance(),o=n.queryMultiple({type:"intersection",queries:[{type:"intersection",components:[Y,Z,H]},{type:"union",components:[E,R,X]}]});for(const s of o){const o=n.getComponent(s,"VertexArray"),i=n.getComponent(s,"IndexArray"),r=n.getComponent(s,"BindGroup"),a=n.getComponent(s,"Buffer"),c=n.getComponent(s,"Position")??void 0,p=n.getComponent(s,"Rotation")??void 0,u=n.getComponent(s,"Scale")??void 0;if(null===o)return void console.error(`No Vertex Array found for entity ${s}`);if(null===r)return void console.error(`No Bind Group found for entity ${s}`);if(null===a)return void console.error(`No Model Matrix Buffer found for entity ${s}`);o.initialise(t),r.initialise(t),a.initialise(t);const l=new ot(112),m=$({position:c,rotation:p,scale:u}),h=nt({position:c,rotation:p,scale:u});l.writeMat4x4f(m),l.writeMat3x3f(h),t.queue.writeBuffer(a.buffer,0,l.buffer),e.setVertexBuffer(0,o.vertexBuffer),e.setBindGroup(1,r.bindGroup),null!==i?(i.initialised||i.initialise(t),e.setIndexBuffer(i.indexBuffer,i.indexFormat),e.drawIndexed(i.indexCount,1)):e.draw(o.vertexCount,1)}}function it(t=1){const e=t/2,n={PPP:new P(e,e,e),PPN:new P(e,e,-e),PNP:new P(e,-e,e),PNN:new P(e,-e,-e),NPP:new P(-e,e,e),NPN:new P(-e,e,-e),NNP:new P(-e,-e,e),NNN:new P(-e,-e,-e)},o={UL:new I(0,0),UR:new I(1,0),BL:new I(0,1),BR:new I(1,1)},s={FRONT:new P(0,0,1),BACK:new P(0,0,-1),LEFT:new P(-1,0,0),RIGHT:new P(1,0,0),TOP:new P(0,1,0),BOTTOM:new P(0,-1,0)};return[{position:n.NPP,uv:o.UL,normal:s.FRONT},{position:n.NNP,uv:o.BL,normal:s.FRONT},{position:n.PPP,uv:o.UR,normal:s.FRONT},{position:n.PPP,uv:o.UR,normal:s.FRONT},{position:n.NNP,uv:o.BL,normal:s.FRONT},{position:n.PNP,uv:o.BR,normal:s.FRONT},{position:n.PPN,uv:o.UL,normal:s.BACK},{position:n.PNN,uv:o.BL,normal:s.BACK},{position:n.NPN,uv:o.UR,normal:s.BACK},{position:n.NPN,uv:o.UR,normal:s.BACK},{position:n.PNN,uv:o.BL,normal:s.BACK},{position:n.NNN,uv:o.BR,normal:s.BACK},{position:n.NPN,uv:o.UL,normal:s.LEFT},{position:n.NNN,uv:o.BL,normal:s.LEFT},{position:n.NPP,uv:o.UR,normal:s.LEFT},{position:n.NPP,uv:o.UR,normal:s.LEFT},{position:n.NNN,uv:o.BL,normal:s.LEFT},{position:n.NNP,uv:o.BR,normal:s.LEFT},{position:n.PPP,uv:o.UL,normal:s.RIGHT},{position:n.PNP,uv:o.BL,normal:s.RIGHT},{position:n.PPN,uv:o.UR,normal:s.RIGHT},{position:n.PPN,uv:o.UR,normal:s.RIGHT},{position:n.PNP,uv:o.BL,normal:s.RIGHT},{position:n.PNN,uv:o.BR,normal:s.RIGHT},{position:n.NPN,uv:o.UL,normal:s.TOP},{position:n.NPP,uv:o.BL,normal:s.TOP},{position:n.PPN,uv:o.UR,normal:s.TOP},{position:n.PPN,uv:o.UR,normal:s.TOP},{position:n.NPP,uv:o.BL,normal:s.TOP},{position:n.PPP,uv:o.BR,normal:s.TOP},{position:n.NNP,uv:o.UL,normal:s.BOTTOM},{position:n.NNN,uv:o.BL,normal:s.BOTTOM},{position:n.PNP,uv:o.UR,normal:s.BOTTOM},{position:n.PNP,uv:o.UR,normal:s.BOTTOM},{position:n.NNN,uv:o.BL,normal:s.BOTTOM},{position:n.PNN,uv:o.BR,normal:s.BOTTOM}]}class D{canvas;settings;device;ctx;canvasFormat;bindGroup0;renderPipeline;perObjectBindGroupLayout;perspectiveViewMatrixBuffer;constructor(t,e,n={}){const o=t.getContext("webgpu");if(null===o)throw new Error("Could not create WebGPU Canvas Context");this.canvas=t,this.device=e,this.ctx=o,this.canvasFormat="rgba8unorm",this.settings={clearColour:n.clearColour??[0,0,0,1]},this.perspectiveViewMatrixBuffer=e.createBuffer({label:"Perspective View Matrix Buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.perObjectBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout 1",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX}]})}async initialise(){new ResizeObserver(t=>{const e=t[0],n=e.devicePixelContentBoxSize[0].inlineSize,o=e.devicePixelContentBoxSize[0].blockSize;this.canvas.width=n,this.canvas.height=o}).observe(this.canvas),await this.initialiseRendering()}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const t=await L.fetch("/WebECS/blinnPhong.wgsl");t.initialise(this.device);const e=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout 0",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX}]});this.bindGroup0=this.device.createBindGroup({label:"Renderer Bind Group 0",layout:e,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrixBuffer}}]});const n=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[e,this.perObjectBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:n,vertex:{module:t.shader,entryPoint:"vertexMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12},{shaderLocation:2,format:"float32x3",offset:20}]}]},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{cullMode:"back"}})}render(t){const e=this.device.createCommandEncoder(),n=e.beginRenderPass({colorAttachments:[{loadOp:"clear",storeOp:"store",view:this.ctx.getCurrentTexture().createView(),clearValue:this.settings.clearColour}]}),o=F.getInstance(),s=o.getComponent(t,"Position"),i=o.getComponent(t,"Rotation"),r=o.getComponent(t,"PerspectiveCamera");if(null===r)return void console.error("No camera found");if(null===s)return void console.error("Camera does not have position component");if(null===i)return void console.error("Camera does not have rotation component");const a=r.calculatePerspectiveViewMatrix(s,i);this.device.queue.writeBuffer(this.perspectiveViewMatrixBuffer,0,a.components.buffer),n.setPipeline(this.renderPipeline),n.setBindGroup(0,this.bindGroup0),st(this.device,n),n.end(),this.device.queue.submit([e.finish(n)])}static async create(t,e={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(null===n)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const o=await n.requestDevice({requiredFeatures:D.requestFeatures(n,"timestamp-query")});if(null===o)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new D(t,o,e)}static requestFeatures(t,...e){return e.filter(e=>{const n=t.features.has(e);return n||console.warn(`GPU Feature ${e} not supported`),n})}}async function rt(){const t=document.getElementById("main"),e=await D.create(t),n=F.getInstance();await e.initialise(),e.settings.clearColour=[.1,.1,.1,1];const o=n.createEntity(),s=new W({});n.addComponent(o,s),n.addComponent(o,new E(0,2,10)),n.addComponent(o,new R(0,0,0));const i=it(),r=n.createEntity(),a=new H({label:"Cube Transforms",size:112,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),c=new R;function p(){s.aspectRatio=t.width/t.height,c.rotateX(.3),c.rotateY(.2),c.rotateZ(.4),e.render(o),requestAnimationFrame(p)}a.initialise(e.device),n.addComponent(r,new Y(i,"Cube")),n.addComponent(r,a),n.addComponent(r,new Z({layout:e.perObjectBindGroupLayout,entries:[{binding:0,resource:a.buffer}]})),n.addComponent(r,new E(0,0,0)),n.addComponent(r,c),n.addComponent(r,new X(2)),p()}rt();