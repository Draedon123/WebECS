!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const e of t)if("childList"===e.type)for(const t of e.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&n(t)}).observe(document,{childList:!0,subtree:!0})}function e(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}function n(t){if(t.ep)return;t.ep=!0;const n=e(t);fetch(t.href,n)}}();class Pt{components;constructor(){this.components=new Float32Array(9),this.components[0]=1,this.components[4]=1,this.components[8]=1}static fromMatrix4(t){const e=new Pt;return e.components[0]=t.components[0],e.components[1]=t.components[1],e.components[2]=t.components[2],e.components[3]=t.components[4],e.components[4]=t.components[5],e.components[5]=t.components[6],e.components[6]=t.components[8],e.components[7]=t.components[9],e.components[8]=t.components[10],e}transpose(){const t=this.components[1],e=this.components[2],n=this.components[5];return this.components[1]=this.components[3],this.components[2]=this.components[6],this.components[3]=t,this.components[5]=this.components[7],this.components[6]=e,this.components[7]=n,this}}class T{components;constructor(){this.components=new Float32Array(16),this.components[0]=1,this.components[5]=1,this.components[10]=1,this.components[15]=1}static multiplyMatrices(t,e,n=new T){const s=t.components[0],o=t.components[1],i=t.components[2],r=t.components[3],a=t.components[4],c=t.components[5],h=t.components[6],u=t.components[7],l=t.components[8],p=t.components[9],m=t.components[10],f=t.components[11],d=t.components[12],g=t.components[13],w=t.components[14],y=t.components[15];let v=e.components[0],x=e.components[1],b=e.components[2],M=e.components[3];return n.components[0]=v*s+x*a+b*l+M*d,n.components[1]=v*o+x*c+b*p+M*g,n.components[2]=v*i+x*h+b*m+M*w,n.components[3]=v*r+x*u+b*f+M*y,v=e.components[4],x=e.components[5],b=e.components[6],M=e.components[7],n.components[4]=v*s+x*a+b*l+M*d,n.components[5]=v*o+x*c+b*p+M*g,n.components[6]=v*i+x*h+b*m+M*w,n.components[7]=v*r+x*u+b*f+M*y,v=e.components[8],x=e.components[9],b=e.components[10],M=e.components[11],n.components[8]=v*s+x*a+b*l+M*d,n.components[9]=v*o+x*c+b*p+M*g,n.components[10]=v*i+x*h+b*m+M*w,n.components[11]=v*r+x*u+b*f+M*y,v=e.components[12],x=e.components[13],b=e.components[14],M=e.components[15],n.components[12]=v*s+x*a+b*l+M*d,n.components[13]=v*o+x*c+b*p+M*g,n.components[14]=v*i+x*h+b*m+M*w,n.components[15]=v*r+x*u+b*f+M*y,n}static copyFrom(t){const e=new T;return e.components.set(t.components),e}static perspective(t,e,n,s){const o=new T,i=1/Math.tan(t/2);if(o.components[0]=i/e,o.components[5]=i,o.components[11]=-1,o.components[15]=0,s!==1/0){const t=1/(n-s);o.components[10]=s*t,o.components[14]=s*n*t}else o.components[10]=-1,o.components[14]=-n;return o}static lookAt(t,e,n){const s=new T,o=1e-6;let i,r,a,c,h,u,l,p,m,f;const d=t.x,g=t.y,w=t.z,y=n.x,v=n.y,x=n.z,b=e.x,M=e.y,C=e.z;return Math.abs(d-b)<o&&Math.abs(g-M)<o&&Math.abs(w-C)<o?(console.warn("Look At too close to Position"),new T):(l=d-b,p=g-M,m=w-C,f=1/Math.sqrt(l*l+p*p+m*m),l*=f,p*=f,m*=f,i=v*m-x*p,r=x*l-y*m,a=y*p-v*l,f=Math.sqrt(i*i+r*r+a*a),f?(f=1/f,i*=f,r*=f,a*=f):(i=0,r=0,a=0),c=p*a-m*r,h=m*i-l*a,u=l*r-p*i,f=Math.sqrt(c*c+h*h+u*u),f?(f=1/f,c*=f,h*=f,u*=f):(c=0,h=0,u=0),s.components[0]=i,s.components[1]=c,s.components[2]=l,s.components[3]=0,s.components[4]=r,s.components[5]=h,s.components[6]=p,s.components[7]=0,s.components[8]=a,s.components[9]=u,s.components[10]=m,s.components[11]=0,s.components[12]=-(i*d+r*g+a*w),s.components[13]=-(c*d+h*g+u*w),s.components[14]=-(l*d+p*g+m*w),s.components[15]=1,s)}copyFrom(t){return this.components.set(t.components),this}invert(){const t=this.components[0],e=this.components[1],n=this.components[2],s=this.components[3],o=this.components[4],i=this.components[5],r=this.components[6],a=this.components[7],c=this.components[8],h=this.components[9],u=this.components[10],l=this.components[11],p=this.components[12],m=this.components[13],f=this.components[14],d=this.components[15],g=t*i-e*o,w=t*r-n*o,y=t*a-s*o,v=e*r-n*i,x=e*a-s*i,b=n*a-s*r,M=c*m-h*p,T=c*f-u*p,C=c*d-l*p,P=h*f-u*m,B=h*d-l*m,F=u*d-l*f,E=g*F-w*B+y*P+v*C-x*T+b*M;if(Math.abs(E)<1e-6)return console.warn("Determinant too close to 0. Matrix not inverted"),this;const U=1/E;return this.components[0]=(i*F-r*B+a*P)*U,this.components[1]=(n*B-e*F-s*P)*U,this.components[2]=(m*b-f*x+d*v)*U,this.components[3]=(u*x-h*b-l*v)*U,this.components[4]=(r*C-o*F-a*T)*U,this.components[5]=(t*F-n*C+s*T)*U,this.components[6]=(f*y-p*b-d*w)*U,this.components[7]=(c*b-u*y+l*w)*U,this.components[8]=(o*B-i*C+a*M)*U,this.components[9]=(e*C-t*B-s*M)*U,this.components[10]=(p*x-m*y+d*g)*U,this.components[11]=(h*y-c*x-l*g)*U,this.components[12]=(i*T-o*P-r*M)*U,this.components[13]=(t*P-e*T+n*M)*U,this.components[14]=(m*w-p*v-f*g)*U,this.components[15]=(c*v-h*w+u*g)*U,this}static fromTranslation(t){const e=new T;return e.components[12]=t.x,e.components[13]=t.y,e.components[14]=t.z,e}static fromScale(t){const e=new T;return e.components[0]=t.x,e.components[5]=t.y,e.components[10]=t.z,e}}class lt{components;constructor(t=0,e=0){this.components=new Float32Array(2),this.components[0]=t,this.components[1]=e}*[Symbol.iterator](){yield this.components[0],yield this.components[1]}get x(){return this.components[0]}get y(){return this.components[1]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}}class g{components;constructor(t=0,e=0,n=0){this.components=new Float32Array(3),this.components[0]=t,this.components[1]=e,this.components[2]=n}*[Symbol.iterator](){yield this.components[0],yield this.components[1],yield this.components[2]}static cross(t,e){const n=t.components[0],s=t.components[1],o=t.components[2],i=e.components[0],r=e.components[1],a=e.components[2];return new g(s*a-o*r,o*i-n*a,n*r-s*i)}static add(t,e){return new g(t.components[0]+e.components[0],t.components[1]+e.components[1],t.components[2]+e.components[2])}add(t){return this.components[0]+=t.components[0],this.components[1]+=t.components[1],this.components[2]+=t.components[2],this}static subtract(t,e){return new g(t.components[0]-e.components[0],t.components[1]-e.components[1],t.components[2]-e.components[2])}clone(){return new g(this.components[0],this.components[1],this.components[2])}static scale(t,e){return new g(t.components[0]*e,t.components[1]*e,t.components[2]*e)}scale(t){return this.components[0]*=t,this.components[1]*=t,this.components[2]*=t,this}static normalise(t){return t.clone().normalise()}normalise(){const t=this.magnitude;if(t<1e-6)return console.warn("Vector magnitude too close to 0 to be normalised"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}}class ht{components;constructor(t=0,e=0,n=0,s=1){this.components=new Float32Array(4),this.components[0]=t,this.components[1]=e,this.components[2]=n,this.components[3]=s}multiply(t){const e=this.components[0],n=this.components[1],s=this.components[2],o=this.components[3],i=t.components[0],r=t.components[1],a=t.components[2],c=t.components[3];return this.x=o*i+e*c+n*a-s*r,this.y=o*r-e*a+n*c+s*i,this.z=o*a+e*r-n*i+s*c,this.w=o*c-e*i-n*r-s*a,this}static clone(t){return new ht(t.components[0],t.components[1],t.components[2],t.components[3])}copyFrom(t){return this.components.set(t.components),this}static invert(t){return ht.clone(t).invert()}invert(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to invert"),this;const e=1/(t*t);return this.components[0]*=-e,this.components[1]*=-e,this.components[2]*=-e,this.components[3]*=e,this}normalise(){const t=this.magnitude;if(t<1e-8)return console.error("Magnitude of vector too close to 0 to normalise"),this;const e=1/t;return this.components[0]*=e,this.components[1]*=e,this.components[2]*=e,this.components[3]*=e,this}get magnitude(){return Math.hypot(this.components[0],this.components[1],this.components[2],this.components[3])}get x(){return this.components[0]}get y(){return this.components[1]}get z(){return this.components[2]}get w(){return this.components[3]}set x(t){this.components[0]=t}set y(t){this.components[1]=t}set z(t){this.components[2]=t}set w(t){this.components[3]=t}}const Jt=180/Math.PI;function Z(t){return t*Jt}const Qt=Math.PI/180;function ct(t){return t*Qt}function _t(t,e,n){return Math.max(Math.min(t,n),e)}function bt(t,e){return t+e-t%e}class F{static instance=null;entityComponentMap;componentEntityMap;nextId;freeIds;constructor(){this.entityComponentMap=new Map,this.componentEntityMap=new Map,this.nextId=0,this.freeIds=[]}static getInstance(){return null===F.instance&&(F.instance=new F),F.instance}queryMultiple(t){const e=t.queries.map(this.querySingular.bind(this));switch(t.type){case"union":return Dt(e);case"intersection":return kt(e)}}querySingular(t){const e=("components"in t?t.components.map(t=>"string"==typeof t?t:t.tag):["string"==typeof t.component?t.component:t.component.tag]).map(t=>this.componentEntityMap.get(t)??[]);switch(t.type){case"union":return Dt(e);case"intersection":return kt(e);case"singleMatch":return e[0]}}createEntity(...t){const e=this.freeIds.length>0?this.freeIds.pop():this.nextId++;this.entityComponentMap.set(e,[]);for(const n of t)this.addComponent(e,n);return e}destroyEntity(t){const e=this.entityComponentMap.get(t);if(void 0!==e){this.entityComponentMap.delete(t);for(const n of e){const e=this.componentEntityMap.get(n.tag);e.splice(e.indexOf(t),1)}}else console.error(`Entity ${t} does not exist`)}addComponent(t,e){const n=this.entityComponentMap.get(t);if(void 0===n)return void console.error(`Entity ${t} does not exist`);n.push(e);const s=this.componentEntityMap.get(e.tag)??[];s.push(t),this.componentEntityMap.set(e.tag,s)}getComponent(t,e){const n=this.entityComponentMap.get(t);return void 0===n?(console.error(`Entity ${t} does not exist`),null):n.find(t=>t.tag===e)??null}}function Dt(t){return qt(t.flat())}function kt(t){const e=t.flat(),n=new Map;for(const t of e)n.has(t)?n.set(t,n.get(t)+1):n.set(t,1);return qt(e.filter(e=>n.get(e)===t.length))}function qt(t){const e=new Map;return t.filter(t=>!e.has(t)&&(e.set(t,!0),!0))}class L{tag;constructor(t){this.tag=t}}class Ct extends L{static tag="Children";children;constructor(t=[]){super(Ct.tag),this.children=t}}class mt extends L{static tag="Parent";parent;constructor(t=null){super(mt.tag),this.parent=t}}class tt extends L{static tag="VertexArray";label;vertexBuffer;rawVertices;constructor(t,e=""){super(tt.tag),this.rawVertices=t,this.label=e}get initialised(){return void 0!==this.vertexBuffer}initialise(t){if(this.initialised)return;const e=new Float32Array(8*this.rawVertices.length);for(let t=0,n=this.rawVertices.length;t<n;t++){const n=8*t,s=this.rawVertices[t];e[n+0]=s.position.x,e[n+1]=s.position.y,e[n+2]=s.position.z,e[n+3]=s.uv.x,e[n+4]=s.uv.y,e[n+5]=s.normal.x,e[n+6]=s.normal.y,e[n+7]=s.normal.z}this.vertexBuffer=t.createBuffer({label:`${this.label} Vertex Buffer`,size:e.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.vertexBuffer,0,e)}get vertexCount(){return this.rawVertices.length}}function te(t=1,e=1){const n=[],s=[],o=[new g(1,0,0),new g(-1,0,0),new g(0,1,0),new g(0,-1,0),new g(0,0,1),new g(0,0,-1)];for(let i=0;i<o.length;i++){const r=void 0,a=ee(o[i],i*(e+1)*(e+1),e,t);for(const t of a.vertices)n.push(t);for(const t of a.indices)s.push(t)}return{vertices:n,indices:s}}function ee(t,e,n,s){const o=[],i=[],r=new g(t.y,t.z,t.x).scale(s),a=g.cross(t,r).normalise().scale(s),c=g.subtract(g.scale(t,.5*s),g.add(r,a).scale(.5)),h=g.scale(r,1/n),u=g.scale(a,1/n);for(let s=0;s<=n;s++)for(let r=0;r<=n;r++){const a=g.scale(h,s).add(g.scale(u,r)),l=g.add(c,a);if(o.push({position:l,uv:new lt(s/n,r/n),normal:t}),s<n&&r<n){const t=e+s+r*(n+1);i.push(t,t+1,t+n+2,t,t+n+2,t+n+1)}}return{vertices:o,indices:i}}function ne(t,e=1){const n=te(2*e,t);return n.vertices.forEach(t=>{t.position.normalise().scale(e);const n=g.normalise(t.position);n.x*=Math.sqrt(1-.5*n.y*n.y-.5*n.z*n.z+n.y*n.y*n.z*n.z/3),n.y*=Math.sqrt(1-.5*n.x*n.x-.5*n.z*n.z+n.x*n.x*n.z*n.z/3),n.z*=Math.sqrt(1-.5*n.y*n.y-.5*n.x*n.x+n.y*n.y*n.x*n.x/3),t.normal=n.normalise();const s=Math.atan2(n.x,n.z),o=Math.asin(n.y),i=(s+Math.PI)/(2*Math.PI),r=(o+Math.PI/2)/Math.PI;t.uv=new lt(i,r)}),n}class nt extends L{static tag="DirectionalLight";static byteLength=32;direction;constructor(t){super(nt.tag),this.direction=t}}class Y{shader;code;label;constructor(t,e){this.code=t,this.label=e}get initialised(){return void 0!==this.shader}initialise(t){this.initialised||(this.shader=t.createShaderModule({label:this.label,code:this.code}))}static async fetch(t,e,n=t=>t){const s=await(await fetch(t)).text(),o=await Y.preprocess(t,s);return new Y(n(o),e)}static async preprocess(t,e){return Y.resolveImports(t,e)}static async resolveImports(t,e,n=[]){const s=/#!import.*\s/g,o=t.split("/"),i=o.slice(0,o.length-1).join("/")+"/",r=e.match(s)?.map(t=>t.replaceAll(/(#!import)|\s/g,"")).filter(t=>!n.includes(t)).map(t=>i+t+".wgsl")??[];return((await Promise.all(r.map(async t=>{const e=await fetch(t);if(!e.ok)return"";const s=await e.text();return Y.resolveImports(t,s,n)}))).join("")+e).replaceAll(s,"")}}class j extends L{static tag="Position";position;constructor(t=0,e=0,n=0){super(j.tag),this.position=new g(t,e,n)}translate(t,e,n){"number"==typeof t&&(t=new g(t,e,n)),this.position.add(t)}get x(){return this.position.x}get y(){return this.position.y}get z(){return this.position.z}set x(t){this.position.x=t}set y(t){this.position.y=t}set z(t){this.position.z=t}}class G extends L{static tag="Rotation";quaternion;constructor(t=0,e=0,n=0){super(G.tag),t=ct(t),e=ct(e),n=ct(n);const s=Math.sin(t/2),o=Math.cos(t/2),i=Math.sin(e/2),r=Math.cos(e/2),a=Math.sin(n/2),c=Math.cos(n/2);this.quaternion=new ht(s*r*c+o*i*a,o*i*c-s*r*a,o*r*a-s*i*c,o*r*c+s*i*a)}getEulerAngles(){this.quaternion.normalise();const t=this.calculateRotationMatrix();let e,n;const s=Math.asin(-_t(t.components[2],-1,1));return Math.abs(t.components[2])<.9999999?(e=Math.atan2(t.components[6],t.components[10]),n=Math.atan2(t.components[1],t.components[0])):(e=0,n=Math.atan2(-t.components[4],t.components[5])),[Z(e),Z(s),Z(n)]}setEulerAngles(t,e,n){return this.quaternion=new G(t,e,n).quaternion,this}get eulerX(){return this.getEulerAngles()[0]}get eulerY(){return this.getEulerAngles()[1]}get eulerZ(){return this.getEulerAngles()[2]}set eulerX(t){const e=this.getEulerAngles();this.quaternion=new G(t,e[1],e[2]).quaternion}set eulerY(t){const e=this.getEulerAngles();this.quaternion=new G(e[0],t,e[2]).quaternion}set eulerZ(t){const e=this.getEulerAngles();this.quaternion=new G(e[0],e[1],t).quaternion}rotateX(t){this.quaternion.multiply(new G(t,0,0).quaternion)}rotateY(t){this.quaternion.multiply(new G(0,t,0).quaternion)}rotateZ(t){this.quaternion.multiply(new G(0,0,t).quaternion)}calculateRotationMatrix(){const t=this.quaternion.x,e=this.quaternion.y,n=this.quaternion.z,s=this.quaternion.w,o=new T;return o.components[0]=1-2*(e*e+n*n),o.components[1]=2*(t*e+n*s),o.components[2]=2*(t*n-e*s),o.components[4]=2*(t*e-n*s),o.components[5]=1-2*(t*t+n*n),o.components[6]=2*(s*t+e*n),o.components[8]=2*(e*s+t*n),o.components[9]=2*(e*n-t*s),o.components[10]=1-2*(t*t+e*e),o}}class Tt extends L{static tag="Scale";scale;constructor(t=1,e,n){super(Tt.tag),"number"==typeof t&&(t=void 0!==e?new g(t,e,n):new g(t,t,t)),this.scale=t}get x(){return this.scale.x}get y(){return this.scale.y}get z(){return this.scale.z}set x(t){this.scale.x=t}set y(t){this.scale.y=t}set z(t){this.scale.z=t}scaleBy(t){this.scale.scale(t)}setScale(t){this.scale.x=t,this.scale.y=t,this.scale.z=t}}class W extends L{static tag="IndexArray";label;indexBuffer;rawIndices;indexFormat;constructor(t,e=""){super(W.tag),this.rawIndices=t,this.indexFormat=W.getIndexFormat(t),this.label=e}get initialised(){return void 0!==this.indexBuffer}initialise(t){if(this.initialised)return;const e=void 0,n=new("uint32"===this.indexFormat?Uint32Array:Uint16Array)("uint16"===this.indexFormat?bt(this.rawIndices.length,2):this.rawIndices.length);n.set(this.rawIndices),this.indexBuffer=t.createBuffer({label:`${this.label} Index Buffer`,size:bt(n.byteLength,4),usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST}),t.queue.writeBuffer(this.indexBuffer,0,n)}static getIndexFormat(t){return Math.max(...t)>65535?"uint32":"uint16"}get indexCount(){return this.rawIndices.length}}class st extends L{static tag="MeshReference";meshKey;constructor(t){super(st.tag),this.meshKey=t}}var U=Uint8Array,K=Uint16Array,se=Int32Array,Vt=new U([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Ot=new U([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),oe=new U([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Nt=function(t,e){for(var n=new K(31),s=0;s<31;++s)n[s]=e+=1<<t[s-1];for(var o=new se(n[30]),s=1;s<30;++s)for(var i=n[s];i<n[s+1];++i)o[i]=i-n[s]<<5|s;return{b:n,r:o}},Yt=Nt(Vt,2),Wt=Yt.b,ie=Yt.r;Wt[28]=258,ie[258]=28;for(var re=Nt(Ot,0),ae=re.b,Mt=new K(32768),C=0;C<32768;++C){var O=(43690&C)>>1|(21845&C)<<1;O=(61680&(O=(52428&O)>>2|(13107&O)<<2))>>4|(3855&O)<<4,Mt[C]=((65280&O)>>8|(255&O)<<8)>>1}for(var _=function(t,e,n){for(var s=t.length,o=0,i=new K(e);o<s;++o)t[o]&&++i[t[o]-1];var r=new K(e),a;for(o=1;o<e;++o)r[o]=r[o-1]+i[o-1]<<1;if(n){a=new K(1<<e);var c=15-e;for(o=0;o<s;++o)if(t[o])for(var h=o<<4|t[o],u=e-t[o],l=r[t[o]-1]++<<u,p=l|(1<<u)-1;l<=p;++l)a[Mt[l]>>c]=h}else for(a=new K(s),o=0;o<s;++o)t[o]&&(a[o]=Mt[r[t[o]-1]++]>>15-t[o]);return a},ot=new U(288),C=0;C<144;++C)ot[C]=8;for(var C=144;C<256;++C)ot[C]=9;for(var C=256;C<280;++C)ot[C]=7;for(var C=280;C<288;++C)ot[C]=8;for(var $t=new U(32),C=0;C<32;++C)$t[C]=5;var ce=_(ot,9,1),le=_($t,5,1),yt=function(t){for(var e=t[0],n=1;n<t.length;++n)t[n]>e&&(e=t[n]);return e},D=function(t,e,n){var s=e/8|0;return(t[s]|t[s+1]<<8)>>(7&e)&n},xt=function(t,e){var n=e/8|0;return(t[n]|t[n+1]<<8|t[n+2]<<16)>>(7&e)},he=function(t){return(t+7)/8|0},Xt=function(t,e,n){return(null==e||e<0)&&(e=0),(null==n||n>t.length)&&(n=t.length),new U(t.subarray(e,n))},ue=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],R=function(t,e,n){var s=new Error(e||ue[t]);if(s.code=t,Error.captureStackTrace&&Error.captureStackTrace(s,R),!n)throw s;return s},pe=function(t,e,n,s){var o=t.length,i=0;if(!o||e.f&&!e.l)return n||new U(0);var r=!n,a=r||2!=e.i,c=e.i;r&&(n=new U(3*o));var h=function(t){var e=n.length;if(t>e){var s=new U(Math.max(2*e,t));s.set(n),n=s}},u=e.f||0,l=e.p||0,p=e.b||0,m=e.l,f=e.d,d=e.m,g=e.n,w=8*o;do{if(!m){u=D(t,l,1);var y=D(t,l+1,3);if(l+=3,!y){var v,x=t[(v=he(l)+4)-4]|t[v-3]<<8,b=v+x;if(b>o){c&&R(0);break}a&&h(p+x),n.set(t.subarray(v,b),p),e.b=p+=x,e.p=l=8*b,e.f=u;continue}if(1==y)m=ce,f=le,d=9,g=5;else if(2==y){var M=D(t,l,31)+257,T=D(t,l+10,15)+4,C=M+D(t,l+5,31)+1;l+=14;for(var P=new U(C),B=new U(19),F=0;F<T;++F)B[oe[F]]=D(t,l+3*F,7);l+=3*T;for(var E=yt(B),G=(1<<E)-1,L=_(B,E,1),F=0;F<C;){var S=L[D(t,l,G)],v;if(l+=15&S,(v=S>>4)<16)P[F++]=v;else{var I=0,A=0;for(16==v?(A=3+D(t,l,3),l+=2,I=P[F-1]):17==v?(A=3+D(t,l,7),l+=3):18==v&&(A=11+D(t,l,127),l+=7);A--;)P[F++]=I}}var q=P.subarray(0,M),z=P.subarray(M);d=yt(q),g=yt(z),m=_(q,d,1),f=_(z,g,1)}else R(1);if(l>w){c&&R(0);break}}a&&h(p+131072);for(var k=(1<<d)-1,O=(1<<g)-1,V=l;;V=l){var I,N=(I=m[xt(t,l)&k])>>4;if((l+=15&I)>w){c&&R(0);break}if(I||R(2),N<256)n[p++]=N;else{if(256==N){V=l,m=null;break}var K=N-254;if(N>264){var F,Y=Vt[F=N-257];K=D(t,l,(1<<Y)-1)+Wt[F],l+=Y}var W=f[xt(t,l)&O],j=W>>4;W||R(3),l+=15&W;var z=ae[j];if(j>3){var Y=Ot[j];z+=xt(t,l)&(1<<Y)-1,l+=Y}if(l>w){c&&R(0);break}a&&h(p+131072);var $=p+K;if(p<z){var X=0-z,Z=Math.min(z,$);for(X+p<0&&R(3);p<Z;++p)n[p]=s[X+p]}for(;p<$;++p)n[p]=n[p-z]}}e.l=m,e.p=V,e.b=p,e.f=u,m&&(u=1,e.m=d,e.d=f,e.n=g)}while(!u);return p!=n.length&&r?Xt(n,0,p):n.subarray(0,p)},me=new U(0),fe=function(t){(31!=t[0]||139!=t[1]||8!=t[2])&&R(6,"invalid gzip data");var e=t[3],n=10;4&e&&(n+=2+(t[10]|t[11]<<8));for(var s=(e>>3&1)+(e>>4&1);s>0;s-=!t[n++]);return n+(2&e)},de=function(t){var e=t.length;return(t[e-4]|t[e-3]<<8|t[e-2]<<16|t[e-1]<<24)>>>0};function ge(t,e){var n=fe(t);return n+8>t.length&&R(6,"invalid gzip data"),pe(t.subarray(n,-8),{i:2},new U(de(t)),e)}var Bt=typeof TextDecoder<"u"&&new TextDecoder,we=0;try{Bt.decode(me,{stream:!0}),we=1}catch{}var ve=function(t){for(var e="",n=0;;){var s=t[n++],o=(s>127)+(s>223)+(s>239);if(n+o>t.length)return{s:e,r:Xt(t,n-1)};o?3==o?(s=((15&s)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e+=String.fromCharCode(55296|s>>10,56320|1023&s)):e+=1&o?String.fromCharCode((31&s)<<6|63&t[n++]):String.fromCharCode((15&s)<<12|(63&t[n++])<<6|63&t[n++]):e+=String.fromCharCode(s)}};function ye(t,e){var n;if(Bt)return Bt.decode(t);var s=ve(t),o=s.s,n;return s.r.length&&R(8),o}async function xe(t){let e;if(t.endsWith(".gz")){const n=await(await fetch(t)).arrayBuffer(),s=void 0;e=ye(ge(new Uint8Array(n)))}else e=await(await fetch(t)).text();const n=e.split(/[\r\n]+/);let s=[],o=[];const i=[],r=[],a=[],c=[],h=[];for(const e of n){if("#"===e[0])continue;const n=e.split(" ");switch(n[0]){case"mtllib":{const e=t.split("/").slice(0,-1).join("/")+"/"+n.slice(1).join(" "),s=await be(e);for(const t of s)c.push(t);break}case"usemtl":""===h[h.length-1].materialName?h[h.length-1].materialName=n[1]:(h[h.length-1].indices=new W(o),s=[],o=[],h.push({name:"_"+h[h.length-1].name,materialName:n[1],vertices:new tt(s)}));break;case"o":{const t=n[1];h.length>0&&(h[h.length-1].indices=new W(o)),o=[],s=[],h.push({name:t,materialName:"",vertices:new tt(s)});break}case"v":{const t=n[4]?parseFloat(n[4]):1,e=parseFloat(n[1])/t,s=parseFloat(n[2])/t,o=parseFloat(n[3])/t;i.push(new g(e,s,o));break}case"vt":{const t=parseFloat(n[1]),e=n[2]?parseFloat(n[2]):0;r.push(new lt(t,e));break}case"vn":{const t=parseFloat(n[1]),e=parseFloat(n[2]),s=parseFloat(n[3]);a.push(new g(t,e,s));break}case"f":{for(let t=1;t<n.length;t++){const e=n[t].split("/"),o=parseInt(e[0])-1,c=parseInt(e[1])-1,h=parseInt(e[2])-1,u=i.at(o),l=r.at(c)??new lt(0,0),p=a.at(h)??new g(0,0,1);s.push({position:u,uv:l,normal:p})}const t=n.length-1,e=s.length-t;for(let n=1;n<t-1;n++)o.push(e,e+n,e+n+1);break}}}return h[h.length-1].indices=new W(o),{meshes:h,materials:c}}async function be(t){const e=(await(await fetch(t)).text()).split(/(newmtl)/),n=[],s=[];for(let o=0;o<e.length;o++){if(!e[o-1]?.startsWith("newmtl"))continue;const i=("newmtl"+e[o]).split(/[\r\n]+/),r={};for(const e of i){const n=e.split(" ");switch(n[0]){case"newmtl":r.name=n[1];break;case"Kd":{const t=255*parseFloat(n[1]),e=255*parseFloat(n[2]),s=255*parseFloat(n[3]);r.texture=I.colour(t,e,s);break}case"map_Kd":{const e=t.split("/").slice(0,-1).join("/")+"/"+n.slice(1).join(" ");s.push(I.fetch([e]).then(t=>{r.texture=t}));break}}}await Promise.all(s),r.texture||(r.texture=I.colour(255,255,255)),n.push(r)}return n}class et{static DEFAULT_TEXTURE_KEY="default";textures;meshes;models;renderer;device;transformsBuffer;transformByteLength;transformsPadding;constructor(t,e,n){this.textures={},this.meshes={},this.models={},this.renderer=t,this.device=e,this.transformByteLength=112;const s=bt(this.transformByteLength,e.limits.minUniformBufferOffsetAlignment);this.transformsPadding=s-this.transformByteLength,this.transformsBuffer=e.createBuffer({label:"Transforms Buffer",size:s*n,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const o=I.colour(255,255,255);o.initialise(e),this.addTexture(et.DEFAULT_TEXTURE_KEY,o)}addTexture(t,e){t in this.textures&&this.textures[t].texture?.texture.destroy(),e.initialise(this.device),1===e.texture.depthOrArrayLayers?this.textures[t]={texture:e,bindGroup:this.device.createBindGroup({layout:this.renderer.perObjectBindGroupLayout,entries:[{binding:0,resource:{buffer:this.transformsBuffer,size:this.transformByteLength+this.transformsPadding}},{binding:1,resource:e.texture.createView()}]})}:this.textures[t]={texture:e}}getTexture(t){return this.textures[t]??this.textures[et.DEFAULT_TEXTURE_KEY]??null}addMesh(t,e,n){t in this.meshes&&(this.meshes[t].vertices.vertexBuffer?.destroy(),this.meshes[t]?.indices?.indexBuffer?.destroy());const s=e instanceof Array?{vertices:new tt(e),indices:n?new W(n):void 0}:e;s.vertices.initialise(this.device),s.indices?.initialise(this.device),this.meshes[t]=s}getMesh(t){return this.meshes[t]??null}async loadModel(t,e,n){switch(n){case"obj":{const n=await xe(t);for(const t of Object.values(n.materials))this.addTexture(t.name,t.texture);for(let t=0;t<n.meshes.length;t++){const e=n.meshes[t];this.addMesh(e.name,e)}this.models[e]=Object.values(n.meshes).map(t=>({meshReference:t.name,textureReference:t.materialName}));break}default:console.error(`Unsupported model type ${n}`)}}getModel(t){return this.models[t]??null}spawnModel(t){if(!(t in this.models))throw new Error(`Model with key ${t} not found`);const e=F.getInstance(),n=this.models[t],s=new Ct,o=e.createEntity(s);for(const t of n){const n=new st(t.meshReference),i=new H(t.textureReference),r=new mt(o),a=e.createEntity(n,i,r);s.children.push(a)}return o}}class H extends L{static tag="TextureReference";textureKey;constructor(t){super(H.tag),this.textureKey=t}}class ft{buffer;dataview;littleEndian;offset;constructor(t,e=!0,n=0){this.buffer=new ArrayBuffer(t),this.dataview=new DataView(this.buffer),this.littleEndian=e,this.offset=n}writeUint8(t){this.dataview.setUint8(this.offset,t),this.offset+=1}writeUint32(t){this.dataview.setUint32(this.offset,t,this.littleEndian),this.offset+=4}writeFloat32(t){this.dataview.setFloat32(this.offset,t,this.littleEndian),this.offset+=4}writeVec3f(t){this.writeFloat32(t.x),this.writeFloat32(t.y),this.writeFloat32(t.z)}writeMat3x3f(t){this.writeFloat32(t.components[0]),this.writeFloat32(t.components[1]),this.writeFloat32(t.components[2]),this.pad(4),this.writeFloat32(t.components[3]),this.writeFloat32(t.components[4]),this.writeFloat32(t.components[5]),this.pad(4),this.writeFloat32(t.components[6]),this.writeFloat32(t.components[7]),this.writeFloat32(t.components[8])}writeMat4x4f(t){new Float32Array(this.buffer,this.offset,16).set(t.components),this.offset+=64}pad(t){this.offset+=t}}function ut(t){const e=new T;if(void 0!==t.position){const n=T.fromTranslation(t.position);T.multiplyMatrices(e,n,e)}if(void 0!==t.rotation){const n=t.rotation.calculateRotationMatrix();T.multiplyMatrices(e,n,e)}if(void 0!==t.scale){const n=T.fromScale(t.scale);T.multiplyMatrices(e,n,e)}return e}function Me(t){const e=t instanceof T?T.copyFrom(t):ut(t);return Pt.fromMatrix4(e.invert()).transpose()}function Be(t,e,n){const s=F.getInstance().querySingular({type:"union",components:[mt,st]});for(let o=0;o<s.length;o++){const i=void 0;Pe(s[o],o,t,e,n)}}function Pe(t,e,n,s,o){const i=F.getInstance(),r=i.getComponent(t,"MeshReference"),a=n.getMesh(r.meshKey);if(null===a)return void console.error(`No mesh found with key ${r.meshKey}`);const c=i.getComponent(t,"TextureReference")?.textureKey??et.DEFAULT_TEXTURE_KEY,h=n.getTexture(c);if(null===h)return void console.error(`No texture found with key ${c}`);const u=i.getComponent(t,"Parent")?.parent??null,l=i.getComponent(t,"Position")??void 0,p=i.getComponent(t,"Rotation")??void 0,m=i.getComponent(t,"Scale")??void 0,f=new ft(n.transformByteLength),d=ut({position:l,rotation:p,scale:m});if(null!==u){const t=i.getComponent(u,"Position")??void 0,e=i.getComponent(u,"Rotation")??void 0,n=i.getComponent(u,"Scale")??void 0;T.multiplyMatrices(d,ut({position:t,rotation:e,scale:n}),d)}const g=Me(d);f.writeMat4x4f(d),f.writeMat3x3f(g);const w=e*(n.transformByteLength+n.transformsPadding);s.queue.writeBuffer(n.transformsBuffer,w,f.buffer),o.setVertexBuffer(0,a.vertices.vertexBuffer),o.setBindGroup(1,h.bindGroup,[e*(n.transformByteLength+n.transformsPadding)]),void 0!==a.indices?(a.indices.initialised||a.indices.initialise(s),o.setIndexBuffer(a.indices.indexBuffer,a.indices.indexFormat),o.drawIndexed(a.indices.indexCount,1)):o.draw(a.vertices.vertexCount,1)}function Kt(t){const e=F.getInstance(),n=e.getComponent(t,"Position"),s=e.getComponent(t,"Rotation"),o=e.getComponent(t,"PerspectiveCamera");return null===o?(console.error("No camera found"),new T):null===n?(console.error("Camera does not have position component"),new T):null===s?(console.error("Camera does not have rotation component"),new T):o.calculatePerspectiveViewMatrix(n,s)}function Ce(t,e,n){n.queue.writeBuffer(e,0,Kt(t).components.buffer)}class it extends L{static tag="AmbientLight";static byteLength=16;constructor(){super(it.tag)}}function Te(t,e,n){const s=F.getInstance().getComponent(t,"Light"),o=s?.colour??new g(0,0,0),i=s?.intensity??0,r=new ft(it.byteLength);r.writeVec3f(g.scale(o,1/255)),r.writeFloat32(i),n.queue.writeBuffer(e,0,r.buffer)}class J extends L{static tag="PointLight";static byteLength=48;maxDistance;decayRate;constructor(t,e){super(J.tag),this.maxDistance=t,this.decayRate=e}}class N extends L{static tag="Light";colour;intensity;constructor(t,e){super(N.tag),this.colour=t,this.intensity=e}}function Fe(t,e){const n=F.getInstance(),s=n.getComponent(t,"Light"),o=n.getComponent(t,"PointLight"),i=n.getComponent(t,"Position");e.writeVec3f(i.position),e.pad(4),e.writeVec3f(g.scale(s.colour,1/255)),e.writeFloat32(s.intensity),e.writeFloat32(o.maxDistance),e.writeFloat32(o.decayRate),e.pad(8)}function Ee(t,e){const n=F.getInstance().querySingular({type:"intersection",components:[N,J,j]}),s=new ft(16+n.length*J.byteLength);s.writeUint32(n.length),s.pad(12);for(const t of n)Fe(t,s);e.queue.writeBuffer(t,0,s.buffer)}class I extends L{static tag="Texture";texture;sources;width;height;label;constructor(t,e,n,s){super(I.tag),this.sources=t,this.width=e,this.height=n,this.label=s}get initialised(){return void 0!==this.texture}initialise(t){this.texture=t.createTexture({label:this.label,size:[this.width,this.height,this.sources.length],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST});for(let e=0;e<this.sources.length;e++){const n=this.sources[e];t.queue.copyExternalImageToTexture({source:n,flipY:!0},{texture:this.texture,origin:[0,0,e]},{width:this.width,height:this.height})}}static async fetch(t,e){const n=await I.toBitmap(t);return new I(n,n[0].width,n[0].height,e)}static colour(t,e,n,s=255,o){const i=new ImageData(new Uint8ClampedArray([t,e,n,s]),1,1);return new I([i],1,1,o)}static createCubemap(t,e){return I.fetch([`${t}/px.png`,`${t}/nx.png`,`${t}/py.png`,`${t}/ny.png`,`${t}/pz.png`,`${t}/nz.png`],e)}static toBitmap(t){const e=t.map(async t=>await createImageBitmap(await(await fetch(t)).blob()));return Promise.all(e)}}class dt extends L{static tag;constructor(){super(dt.tag)}}class Ft{inversePespectiveViewMatrix;bindGroups;device;renderBindGroupLayout;renderPipeline;sampler;constructor(t,e,n){this.device=t,this.bindGroups=new WeakMap,this.inversePespectiveViewMatrix=t.createBuffer({label:"Inverse Perspective View Matrix",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.sampler=this.device.createSampler({label:"Skybox Sampler",minFilter:"linear",magFilter:"linear"}),this.renderBindGroupLayout=this.device.createBindGroupLayout({label:"Skybox Bind Group Layout",entries:[{binding:0,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:1,texture:{viewDimension:"cube"},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{},visibility:GPUShaderStage.FRAGMENT}]});const s=this.device.createPipelineLayout({label:"Skybox Render Pipeline Layout",bindGroupLayouts:[this.renderBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Skybox Render Pipeline",layout:s,vertex:{module:e.shader,entryPoint:"vertexMain"},fragment:{module:e.shader,entryPoint:"fragmentMain",targets:[{format:n}]},depthStencil:{depthWriteEnabled:!0,depthCompare:"less-equal",format:"depth24plus"}})}static async create(t,e){const n=await Y.fetch("/WebECS/skybox.wgsl","Skybox Shader Module");return n.initialise(t),new Ft(t,n,e)}render(t,e,n){const s=F.getInstance().querySingular({type:"intersection",components:[dt,H]})[0];if(!s)return;const o=F.getInstance().getComponent(s,"TextureReference"),i=t.getTexture(o.textureKey)?.texture;if(!i)return void console.error(`No texture with key ${o.textureKey} found`);if(!this.bindGroups.has(i)){const t=this.device.createBindGroup({label:`Skybox ${o.textureKey} Bind Group`,layout:this.renderBindGroupLayout,entries:[{binding:0,resource:this.sampler},{binding:1,resource:i.texture.createView({dimension:"cube"})},{binding:2,resource:{buffer:this.inversePespectiveViewMatrix}}]});this.bindGroups.set(i,t)}const r=T.copyFrom(n).invert();this.device.queue.writeBuffer(this.inversePespectiveViewMatrix,0,r.components.buffer),e.setPipeline(this.renderPipeline),e.setBindGroup(0,this.bindGroups.get(i)),e.draw(3)}}function Se(t,e,n){const s=F.getInstance(),o=s.getComponent(t,"Light"),i=s.getComponent(t,"DirectionalLight")?.direction??new g(0,1,0),r=o?.colour??new g(0,0,0),a=o?.intensity??0,c=new ft(nt.byteLength);c.writeVec3f(i),c.pad(4),c.writeVec3f(g.scale(r,1/255)),c.writeFloat32(a),n.queue.writeBuffer(e,0,c.buffer)}class pt{canvas;settings;device;ctx;canvasFormat;bindGroup0;renderPipeline;depthTexture;skyboxRenderer;resourceManager;perObjectBindGroupLayout;perspectiveViewMatrixBuffer;ambientLightBuffer;directionalLightBuffer;pointLightsBuffer;sampler;constructor(t,e,n={}){const s=t.getContext("webgpu");if(null===s)throw new Error("Could not create WebGPU Canvas Context");this.canvas=t,this.device=e,this.ctx=s,this.canvasFormat="rgba8unorm",this.settings={clearColour:n.clearColour??[0,0,0,1],maxPointLights:n.maxPointLights??32},this.perspectiveViewMatrixBuffer=e.createBuffer({label:"Perspective View Matrix Buffer",size:64,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.ambientLightBuffer=e.createBuffer({label:"Renderer Ambient Light Buffer",size:16,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.directionalLightBuffer=e.createBuffer({label:"Renderer Directional Light Buffer",size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.pointLightsBuffer=e.createBuffer({label:"Renderer Point Lights Buffer",size:16+J.byteLength*this.settings.maxPointLights,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.perObjectBindGroupLayout=this.device.createBindGroupLayout({label:"Renderer Per Object Bind Group Layout",entries:[{binding:0,buffer:{type:"uniform",hasDynamicOffset:!0},visibility:GPUShaderStage.VERTEX},{binding:1,texture:{},visibility:GPUShaderStage.FRAGMENT}]}),this.resourceManager=new et(this,e,512),this.depthTexture=this.createDepthTexture(),this.sampler=e.createSampler()}async initialise(){new ResizeObserver(t=>{const e=t[0],n=e.devicePixelContentBoxSize[0].inlineSize,s=e.devicePixelContentBoxSize[0].blockSize;this.canvas.width=n,this.canvas.height=s,this.depthTexture?.destroy(),this.depthTexture=this.createDepthTexture()}).observe(this.canvas),await this.initialiseRendering()}createDepthTexture(){return this.device.createTexture({label:"Renderer Depth Texture",size:[this.canvas.width,this.canvas.height],format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT})}async initialiseRendering(){this.ctx.configure({device:this.device,format:this.canvasFormat});const t=await Y.fetch("/WebECS/blinnPhong.wgsl");t.initialise(this.device);const e=this.device.createBindGroupLayout({label:"Renderer Bind Group Layout 0",entries:[{binding:0,buffer:{type:"uniform"},visibility:GPUShaderStage.VERTEX},{binding:1,sampler:{},visibility:GPUShaderStage.FRAGMENT},{binding:2,buffer:{type:"uniform"},visibility:GPUShaderStage.FRAGMENT},{binding:3,buffer:{type:"uniform"},visibility:GPUShaderStage.FRAGMENT},{binding:4,buffer:{type:"read-only-storage"},visibility:GPUShaderStage.FRAGMENT}]});this.bindGroup0=this.device.createBindGroup({label:"Renderer Bind Group 0",layout:e,entries:[{binding:0,resource:{buffer:this.perspectiveViewMatrixBuffer}},{binding:1,resource:this.sampler},{binding:2,resource:{buffer:this.ambientLightBuffer}},{binding:3,resource:{buffer:this.directionalLightBuffer}},{binding:4,resource:{buffer:this.pointLightsBuffer}}]});const n=this.device.createPipelineLayout({label:"Renderer Render Pipeline Layout",bindGroupLayouts:[e,this.perObjectBindGroupLayout]});this.renderPipeline=this.device.createRenderPipeline({label:"Renderer Render Pipeline",layout:n,vertex:{module:t.shader,entryPoint:"vertexMain",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12},{shaderLocation:2,format:"float32x3",offset:20}]}]},fragment:{module:t.shader,entryPoint:"fragmentMain",targets:[{format:this.canvasFormat}]},primitive:{cullMode:"back"},depthStencil:{format:"depth24plus",depthCompare:"less",depthWriteEnabled:!0}}),this.skyboxRenderer=await Ft.create(this.device,this.canvasFormat)}render(t){const e=this.device.createCommandEncoder(),n=e.beginRenderPass({colorAttachments:[{loadOp:"clear",storeOp:"store",view:this.ctx.getCurrentTexture().createView(),clearValue:this.settings.clearColour}],depthStencilAttachment:{view:this.depthTexture.createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}});F.getInstance().getComponent(t,"PerspectiveCamera").aspectRatio=this.canvas.width/this.canvas.height,Ce(t,this.perspectiveViewMatrixBuffer,this.device);const s=F.getInstance(),o=s.querySingular({type:"intersection",components:[N,it]}),i=s.querySingular({type:"intersection",components:[N,nt]});Te(o[0],this.ambientLightBuffer,this.device),Se(i[0],this.directionalLightBuffer,this.device),Ee(this.pointLightsBuffer,this.device),this.skyboxRenderer.render(this.resourceManager,n,Kt(t)),n.setPipeline(this.renderPipeline),n.setBindGroup(0,this.bindGroup0),Be(this.resourceManager,this.device,n),n.end(),this.device.queue.submit([e.finish(n)])}static async create(t,e={}){if(!("gpu"in navigator))throw new Error("WebGPU not supported");const n=await navigator.gpu.requestAdapter();if(null===n)throw new Error("Could not find suitable GPU Adapter. Maybe your browser doesn't support WebGPU?");const s=await n.requestDevice({requiredFeatures:pt.requestFeatures(n,"timestamp-query")});if(null===s)throw new Error("Could not find suitable GPU Device. Maybe your browser doesn't support WebGPU?");return new pt(t,s,e)}static requestFeatures(t,...e){return e.filter(e=>{const n=t.features.has(e);return n||console.warn(`GPU Feature ${e} not supported`),n})}}class Et extends L{static tag="PerspectiveCamera";fovDegrees;near;far;aspectRatio;constructor(t={}){super(Et.tag),this.fovDegrees=t.fov??60,this.near=t.near??.001,this.far=t.far??1e3,this.aspectRatio=t.aspectRatio??16/9}get fovRadians(){return ct(this.fovDegrees)}set fovRadians(t){this.fovDegrees=Z(t)}calculatePerspectiveViewMatrix(t,e){const n=this.calculatePerspectiveMatrix(),s=this.calculateViewMatrix(t,e);return T.multiplyMatrices(n,s,s),s}calculateViewMatrix(t,e){return ut({position:t,rotation:e}).invert()}calculatePerspectiveMatrix(){return T.perspective(this.fovRadians,this.aspectRatio,this.near,this.far)}}function Le(t,e){const n=F.getInstance(),s=n.getComponent(t,"Position"),o=n.getComponent(t,"Rotation");if(null===s)return void console.error("Entity does not have position component");if(null===o)return void console.error("Entity does not have rotation component");const i=g.subtract(e,s.position);i.magnitude<1e-6?console.error("Look at point too close to entity position"):(i.normalise(),o.setEulerAngles(Z(Math.asin(i.y)),180+Z(Math.atan2(i.x,i.z)),0))}class Ue{settings;callbacks=[];frameID;lastFrameTime;totalTime;frame;constructor(t={}){this.frameID=null,this.lastFrameTime=0,this.totalTime=0,this.frame=1,this.callbacks=[],this.settings={wormholeThreshold:t.wormholeThreshold??500}}start(){this.running||(this.frame=1,this.totalTime=0,this.lastFrameTime=-1,this.frameID=requestAnimationFrame(this.tick.bind(this)))}stop(){this.running&&(cancelAnimationFrame(this.frameID),this.frameID=null)}toggle(){this.running?this.stop():this.start()}addCallback(t){this.callbacks.push(t)}tick(t){this.lastFrameTime<0&&(this.lastFrameTime=t);const e=t-this.lastFrameTime,n=this.totalTime+e;if(e<this.settings.wormholeThreshold){const t={deltaTime:e,totalTime:n,frame:this.frame++};for(const e of this.callbacks)e(t);this.totalTime=n}this.lastFrameTime=t,this.frameID=requestAnimationFrame(this.tick.bind(this))}get running(){return null!==this.frameID}}async function Ge(){const t=document.getElementById("main"),e=await pt.create(t),n=F.getInstance();await e.initialise(),e.settings.clearColour=[.1,.1,.1,1];const s=new Et({}),o=new j(0,3,10),i=n.createEntity(s,o,new G(0,0,0));await e.resourceManager.loadModel("/WebECS/web-assets/iss/ISS_stationary.obj.gz","ISS","obj");const r=e.resourceManager.spawnModel("ISS"),a=new G;n.addComponent(r,new j(0,0,0)),n.addComponent(r,new Tt(.1)),n.addComponent(r,a),n.createEntity(new N(new g(255,255,255),.2),new it),n.createEntity(new N(new g(255,255,255),.4),new nt(new g(0,1,0)));const c=await I.createCubemap("/WebECS/web-assets/skybox");e.resourceManager.addTexture("Skybox",c),n.createEntity(new dt,new H("Skybox"));const h=["Alpine","Gaseous1","Gaseous2","Gaseous3","Gaseous4","Icy","Martian","Savannah","Swamp","Terrestrial1","Terrestrial2","Terrestrial3","Terrestrial4","Tropical","Venusian","Volcanic"];await Promise.all(h.map(async t=>{const n=await I.fetch([`/WebECS/web-assets/planets/${t}.png`]);e.resourceManager.addTexture(t,n)}));const u=ne(7,1);e.resourceManager.addMesh("Sphere",u.vertices,u.indices);const l=20;for(let t=0;t<l;t++)n.createEntity(new st("Sphere"),new H(h[Math.floor(p(0,h.length))]),new j(Math.sign(Math.random()-.5)*p(10,50),Math.sign(Math.random()-.5)*p(-10,10),Math.sign(Math.random()-.5)*p(10,50)),new G(p(0,360),p(0,360),p(0,360)));function p(t,e){return(e-t)*Math.random()+t}n.createEntity(new N(new g(255,255,255),.3),new J(100,0),o);const m=new Ue;let f=0,d=0,w=0;m.addCallback(t=>{f+=.001*t.deltaTime,d-=5e-4*t.deltaTime,w+=.002*t.deltaTime,o.x=10*Math.sin(1e-4*t.totalTime),o.z=10*Math.cos(1e-4*t.totalTime),a.setEulerAngles(f,d,w),Le(i,new g(0,0,0)),e.render(i)}),document.getElementById("loading")?.remove(),m.start()}Ge();